<%= stylesheet_link_tag "common2.css" %>
<%= stylesheet_link_tag "classy.css" %>
<%= stylesheet_link_tag "plan.css" %>
<%= javascript_include_tag "highcharts.js" %>
<%= javascript_include_tag "highcharts-more.js" %>
<%= javascript_include_tag "placeholder.js" %>

<div class="welcomes">
  <div id="page-wrapper">
    <div id="top-tabs">
      <div class="top-tabs-content">
        <a href="/home/questions"><b>1.</b> <span>测试您的风险承受度</span></a> &nbsp;>&nbsp;

        <b>2.</b> <span>查看您的理财规划方案</span>
        <!--
        <i class="separator icon-chevron-right disabled"></i>
        <span class="disabled"><b>3.</b> <span>开通帐号</span></span>
         -->
      </div>
    </div>
    <div id="page-content">
      <div class="classy plan-content">
        <div class="plan-column left">
          <div id="container" style="margin-left: 50px;"></div>
          <p id="first" style="font-size: 16px;padding-left: 30px;"></p>
          <!--
          <div class="risk-control">
            <button id="risk-down" class="risk-adjust icon-minus"></button>
            <input id="risk-number">
            <button id="risk-up" class="risk-adjust icon-plus"></button>
          </div>
          -->
          <div id="revert-risk-msg" style="visibility: hidden;">(初始测试值为 <a href="javascript:" id="revert-risk"><%= cookies[:asset_allocation].split('|')[3] %></a>)</div>
          <div id="risk-warning" style="display: none;">风险高于推荐</div>
          <a href="/home/questions" id="change-answers">修改我的答案</a>
          <hr style="margin-left:14px; margin-right:14px">
          <p class="amount-to-invest-label sidebar-label">投资金额</p>
          <input type="text" id="amount-to-invest" height="38">
          <p>(最低50000元)</p>
          <span class="ktip-link" id="faq-amount"><a class="ktip-a" onmouseover="w.tip(this)" onclick="w.tip(this,1)" href="javascript:void(0)" tabindex="-1" data-w="300px" data-tip=" 首先您需要预留6个月您家庭的日常开销（包括房贷、水电费、日常消费等），用以应对一些家庭突发性的开销，如果您愿意的话，您也可以将这6个月的日常开销放在流动性超强的资产中，例如货币型基金，银行开放式理财产品中。剩余的资金，您可以作为一个中长期的投资，这部分金额您可以作为投资金额输入，看看我们给您配置建议。">我该如何决定？</a></span>
        </div>
        <div class="plan-column center">
          <div class="account-types">
            <div class="account-type-tab active" id="taxable-account-type">
              <p><span class="product">您的理财规划方案</span></p>
              <p class="product-description">仅为个人或家庭服务</p>
            </div>
            <div class="clearfix"></div>
          </div>

          <div class="plan-details">
            <section id="asset-allocation" class="">
             <table style="width: 100%;">
               <tr><td style="width: 135px;">
              <div class="allocation-chart-container">
                <div id="container2" style="width: 130px;height: 130px;"></div>
                <!--
                <ul class="allocation-questions">
                  <li><span class="ktip-link right" id="faq-mix"><a class="ktip-a" onmouseover="w.tip(this)" onclick="w.tip(this,1)" href="javascript:void(0)" tabindex="-1" data-w="320px" data-d="0" data-tip=" 我们的目标是设计一系列投资品种组合，根据您的风险承受度，最大化您的投资收益（扣除掉任何手续费、赎回费等交易成本）。采用均值方差优化现代投资配置方案，为您做最优化的理财规划。您可以详细阅读我们的投资白皮书获得更多理财规划理念。">为什么是这样规划的?</a></span></li>

                  <li><span class="ktip-link right" id="faq-change"><a class="ktip-a" onmouseover="w.tip(this)" onclick="w.tip(this,1)" href="javascript:void(0)" tabindex="-1" data-w="300px" data-d="0" data-tip=" 您不可以直接修改。但您可以通过修改您的风险承受度进行间接修改，你可以在页面的左侧进行修改。">可以修改它吗?</a></span></li>
                </ul>
                -->
              </div>
               </td><td>
              <table id="allocation" class="table allocation report apply-asset-class-colors">
                <thead>
                <tr>
                  <th></th>
                  <th>投资品种</th>
                  <th class="number">%</th>
                  <th class="number">总额</th>
                </tr>
                </thead>
                <tbody>
                <tr class="" data-type="US_STOCKS">
                  <td class="asset-class-color"><div class="legend US_STOCKS"></div></td>
                  <td class="asset-class-name">
                    <span class="ktip-link"><a class="ktip-a">股票、基金</a></span>
                  </td>
                  <td class="asset-class-percentage number" id="f1">43%</td>
                  <td class="asset-class-amount number" id="f2">￥21,501</td>
                </tr>
                <tr class="" data-type="INTL_EMERGING">
                  <td class="asset-class-color"><div class="legend INTL_EMERGING"></div></td>
                  <td class="asset-class-name">
                    <span class="ktip-link"><a class="ktip-a">国债、企业债</a></span>
                  </td>
                  <td class="asset-class-percentage number" id="s1">14%</td>
                  <td class="asset-class-amount number" id="s2">￥4,000</td>
                </tr>
                <tr class="" data-type="DIV_STOCKS">
                  <td class="asset-class-color"><div class="legend DIV_STOCKS"></div></td>
                  <td class="asset-class-name">
                    <span class="ktip-link"><a class="ktip-a">信托</a></span>
                  </td>
                  <td class="asset-class-percentage number" id="t1">8%</td>
                  <td class="asset-class-amount number" id="t2">￥7,000</td>
                </tr>

                <tr class="" data-type="MUNI_BONDS">
                  <td class="asset-class-color"><div class="legend MUNI_BONDS"></div></td>
                  <td class="asset-class-name">
                    <span class="ktip-link"><a class="ktip-a">银行理财产品</a></span>
                  </td>
                  <td class="asset-class-percentage number" id="a1">35%</td>
                  <td class="asset-class-amount number" id="a2">￥17,501</td>
                </tr>
                </tbody>
              </table>
                 </td></tr></table>
              <div class="clearfix"></div>
            </section>
          </div>
        </div>
        <% if @webuser.username=='admin' %>
        <div class="plan-column right">
          <div style="position:relative;width: 204px;">
            <div id="position-saver">
              <div class="open-account-container">
                <p class="open-account-intro">保存您的理财规划方案</p> <br><br>
                <a class="login-window" href="#login-box">保存</a> <br><br>
                <a id="save-your-plan" href="javascript:">让我们为您投资</a>
              </div>
            </div>
          </div>
        </div>
            <% end %>
      </div>
    </div>
  </div>
</div>

<div id='login-box' class='login-popup'>
  <div class="popup">
    <a class="close" href="javascript:">×</a>
    <h1>保存您的理财规划方案</h1>
    <p>输入您的电子邮箱以及登录密码，我们将把您的理财规划方案链接地址发送给您，你以后直接登录后就可以查看您的方案，并查看到其他理财专家给您的建议。</p>
    <input id="email" type="text" placeholder="电子邮箱地址"><br>
    <input id="username" type="text" placeholder="登录名（保证您的个人隐私不会因邮箱名而...）"><br>
    <input id="password" type="password" placeholder="登录密码"><br><br>
    <a href="javascript:void(userconfig('#username','#password','#email'))" id="save">保存方案</a>
  </div>
</div>

<script>
    $(function () {
        var chart;

        <% if @webuser.username!='admin' %>
        var dataArray2= [<%= @webuser.risktolerance %>];
        <% else %>
        var dataArray2= [<%= cookies[:asset_allocation].split('|')[3] %>];
        <% end %>

        $(document).ready(function() {
            var chart = new Highcharts.Chart({

                        chart: {
                            renderTo: 'container',
                            type: 'gauge',
                            plotBorderWidth: 1,
                            plotBackgroundColor: {
                                linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                                stops: [
                                    [0, '#FFF4C6'],
                                    [0.3, '#FFFFFF'],
                                    [1, '#FFF4C6']
                                ]
                            },
                            plotBackgroundImage: null,
                            height: 135,
                            width: 180
                        },

                        title: {
                            text: '您的风险承受度'
                        },

                        pane: [{
                            startAngle: -45,
                            endAngle: 45,
                            background: null,
                            center: ['50%', '145%'],
                            size: 150
                        }],

                        yAxis: [{
                            min: 0,
                            max: 10,
                            tickInterval: 2,
                            minorTickPosition: 'outside',
                            tickPosition: 'outside',
                            labels: {
                                rotation: 'auto',
                                distance: 20
                            },
                            plotBands: [{
                                from: 0,
                                to: 2,
                                color: '#09a509',
                                innerRadius: '100%',
                                outerRadius: '105%'
                            },{
                                from: 2,
                                to: 4,
                                color: '#69c908',
                                innerRadius: '100%',
                                outerRadius: '105%'
                            },{
                                from: 4,
                                to: 6,
                                color: '#eded07',
                                innerRadius: '100%',
                                outerRadius: '105%'
                            },{
                                from: 6,
                                to: 8,
                                color: '#fa8c1e',
                                innerRadius: '100%',
                                outerRadius: '105%'
                            },{
                                from: 8,
                                to: 10,
                                color: '#C02316',
                                innerRadius: '100%',
                                outerRadius: '105%'
                            }],
                            pane: 0,
                            title: false
                        }],

                        plotOptions: {
                            gauge: {
                                dataLabels: {
                                    enabled: false
                                },
                                dial: {
                                    radius: '90%'
                                }
                            }
                        },
                        series: [{
                            data: dataArray2,
                            yAxis: 0
                        }],
                        credits: {
                            enabled: false
                        }
                    },
                    // Let the music play
                    function(chart) {
                        $("#risk-up,#risk-down").on("click", function() {
                            var left = chart.series[0].points[0],
                                    leftVal;
                            if(this.id=='risk-up'){
                                w.planPage.risk(w.planPage._riskValue+0.5)
                            }
                            else{
                                w.planPage.risk(w.planPage._riskValue-0.5)
                            }
                            leftVal = w.planPage._riskValue;
                            left.update(leftVal, false);
                            chart.redraw();
                        });
                        $("#revert-risk").on("click", function () {
                            w.planPage.risk(<%= cookies[:asset_allocation].split('|')[3] %>);
                            var left = chart.series[0].points[0],leftVal;
                            leftVal =<%= cookies[:asset_allocation].split('|')[3] %>;
                            left.update(leftVal, false);
                            chart.redraw();
                        });
                    });
        });
    });
</script>

<script type="text/javascript">
    var chart=null;
    var rate = [[0.38,0.05,0.22,0.35],[0.48,0.05,0.12,0.35],[0.48,0.05,0.12,0.35],[0.47,0.05,0.13,0.35],[0.46,0.05,0.14,0.35],
        [0.45,0.06,0.14,0.35],[0.43,0.08,0.14,0.35],[0.43,0.09,0.13,0.35],[0.46,0.11,0.1,0.33],[0.48,0.12,0.11,0.29],
        [0.5,0.13,0.11,0.26],[0.52,0.14,0.11,0.23],[0.53,0.15,0.11,0.21],[0.55,0.15,0.12,0.18],[0.56,0.16,0.13,0.15],
        [0.57,0.17,0.13,0.13],[0.59,0.18,0.14,0.09],[0.6,0.1,0.15,0.06],[0.61,0.22,0.12,0.05],[0.57,0.28,0.1,0.05]];
    <% if @webuser.username!='admin' %>
    a=rate[Math.round(2*<%= @webuser.risktolerance %>)-1][0]
    b=rate[Math.round(2*<%= @webuser.risktolerance %>)-1][1]
    c=rate[Math.round(2*<%= @webuser.risktolerance %>)-1][2]
    d=rate[Math.round(2*<%= @webuser.risktolerance %>)-1][3]
    $("#first").html("("+'<%= @webuser.risktolerance %>'+")")
    <% else %>
    a=rate[Math.round(2*<%= cookies[:asset_allocation].split('|')[3] %>)-1][0]
    b=rate[Math.round(2*<%= cookies[:asset_allocation].split('|')[3] %>)-1][1]
    c=rate[Math.round(2*<%= cookies[:asset_allocation].split('|')[3] %>)-1][2]
    d=rate[Math.round(2*<%= cookies[:asset_allocation].split('|')[3] %>)-1][3]
    $("#first").html("("+"<%= cookies[:asset_allocation].split('|')[3] %>"+")")
    <% end %>
    var dataArray= [
        ['1',a],
        ['2',b],
        ['3',c],
        ['4',d]
    ];
    $(function () {
        $(document).ready(function () {

            // Build the chart
            chart = new Highcharts.Chart({
                chart: {
                    renderTo: 'container2',
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    events: {
                        load: function() {
                            $("#risk-up,#risk-down").on("click", function() {
                                // set up the updating of the chart each second
                                var series = this.series;
                                var a, b, c, d;
                                var data = [];
                                var rate = [[0.38,0.05,0.22,0.35],[0.48,0.05,0.12,0.35],[0.48,0.05,0.12,0.35],[0.47,0.05,0.13,0.35],[0.46,0.05,0.14,0.35],
                                    [0.45,0.06,0.14,0.35],[0.43,0.08,0.14,0.35],[0.43,0.09,0.13,0.35],[0.46,0.11,0.1,0.33],[0.48,0.12,0.11,0.29],
                                    [0.5,0.13,0.11,0.26],[0.52,0.14,0.11,0.23],[0.53,0.15,0.11,0.21],[0.55,0.15,0.12,0.18],[0.56,0.16,0.13,0.15],
                                    [0.57,0.17,0.13,0.13],[0.59,0.18,0.14,0.09],[0.6,0.1,0.15,0.06],[0.61,0.22,0.12,0.05],[0.57,0.28,0.1,0.05]];

                                <% if @webuser.username!='admin' %>
                                a=rate[2*<%= @webuser.risktolerance %>-1][0]
                                b=rate[2*<%= @webuser.risktolerance %>-1][1]
                                c=rate[2*<%= @webuser.risktolerance %>-1][2]
                                d=rate[2*<%= @webuser.risktolerance %>-1][3]
                                <% else %>
                                a=rate[2*<%= cookies[:asset_allocation].split('|')[3] %>-1][0]
                                b=rate[2*<%= cookies[:asset_allocation].split('|')[3] %>-1][1]
                                c=rate[2*<%= cookies[:asset_allocation].split('|')[3] %>-1][2]
                                d=rate[2*<%= cookies[:asset_allocation].split('|')[3] %>-1][3]
                                <% end %>
                                data.push(['1',a]);
                                data.push(['2', b]);
                                data.push(['3', c]);
                                data.push(['4', d]);
                                chart.series[0].setData(data);
                                chart.isDirtyLegend = true;
                                chart.redraw();
                            });
                        }
                    }
                },
                title: {
                    text: false
                },
                tooltip: false,
                plotOptions: {
                    pie: {
                        allowPointSelect: false,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false
                        },
                        showInLegend: true,
                        size: 120,
                        borderWidth: 0
                    }
                },
                series: [{
                    type: 'pie',
                    name: '比例',
                    data: dataArray
                }],
                legend: false,
                credits: {
                    enabled: false
                }
            });
        });
        Highcharts.theme = {
            colors: ['#d76f32', '#f1b77a', '#9c7746', '#294b6e']
        };

// Apply the theme
        var highchartsOptions = Highcharts.setOptions(Highcharts.theme);
    });
</script>

<script>
    $('a.login-window').click(function() {
        var loginBox = $(this).attr('href');
        //Fade in the Popup and add close button
        $(loginBox).fadeIn(300);
        //Set the center alignment padding + border
        var popMargTop = ($(loginBox).height() + 24) / 2;
        var popMargLeft = ($(loginBox).width() + 24) / 2;

        $(loginBox).css({
            'margin-top' : -popMargTop,
            'margin-left' : -popMargLeft
        });

        // Add the mask to body
        $('body').append('<div id="mask"></div>');
        $('#mask').fadeIn(300);

        return false;
    });

    // When clicking on the button close or the mask layer the popup closed
    $('a.close, #mask').live('click', function() {
        $('#mask , .login-popup').fadeOut(300 , function() {
            $('#mask').remove();
        });
        return false;
    });

    function userconfig(uid,pid,eid){
        var myreg = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}.*$/;

        if($(uid).attr("value")==""){
            alert("用户名为空！");
        }
        else if($(pid).attr("value")==""){
            alert("密码为空！");
        }
        else if($(eid).attr("value")==""){
            alert("电子邮箱为空！");
        }
        else if(!myreg.test($(eid).attr("value"))){
            alert("电子邮箱格式不正确！");
        }
        else{
            $.get("/admin/userconfigajax/0",{username:$(uid).attr("value"),password:$(pid).attr("value"),tel:1,address: 1,postcode: 1,name:1,email:$(eid).attr("value"),company:1,division:1,organuser:0,securitiesnum:0,memberlevel:0,risktolerance:'<%= cookies[:asset_allocation].split('|')[3] %>'},function(data){
                if(data=="f"){
                    // alert("用户名已注册！");
                    userlogin(uid,pid,0);
                }
                else if(data=="s"){
                    // alert("用户注册成功！");
                    //location.reload();
                     userlogin(uid,pid,0);
                    //email('#username');
                }
            })
        }
    }

    function userlogin(uid,pid,organ){

        $.get("/admin/userlogin",{username:$(uid).attr("value"),password:$(pid).attr("value")},function(data){
            if(data=="f"){
                alert("登录失败!");
            }
            else
            {
                location.href="/personmanagement/personinfo/0";
            }
        })
    }
</script>

<script>
    window.onload=function(){
    var rate = [[0.38,0.05,0.22,0.35],[0.48,0.05,0.12,0.35],[0.48,0.05,0.12,0.35],[0.47,0.05,0.13,0.35],[0.46,0.05,0.14,0.35],
        [0.45,0.06,0.14,0.35],[0.43,0.08,0.14,0.35],[0.43,0.09,0.13,0.35],[0.46,0.11,0.1,0.33],[0.48,0.12,0.11,0.29],
        [0.5,0.13,0.11,0.26],[0.52,0.14,0.11,0.23],[0.53,0.15,0.11,0.21],[0.55,0.15,0.12,0.18],[0.56,0.16,0.13,0.15],
        [0.57,0.17,0.13,0.13],[0.59,0.18,0.14,0.09],[0.6,0.1,0.15,0.06],[0.61,0.22,0.12,0.05],[0.57,0.28,0.1,0.05]];
      <% if @webuser.username!='admin' %>
          a=rate[Math.round(2*<%= @webuser.risktolerance %>)-1][0]
          b=rate[Math.round(2*<%= @webuser.risktolerance %>)-1][1]
          c=rate[Math.round(2*<%= @webuser.risktolerance %>)-1][2]
          d=rate[Math.round(2*<%= @webuser.risktolerance %>)-1][3]
          $("#first").html("("+'<%= @webuser.risktolerance %>'+")")
      <% else %>
          a=rate[Math.round(2*<%= cookies[:asset_allocation].split('|')[3] %>)-1][0]
          b=rate[Math.round(2*<%= cookies[:asset_allocation].split('|')[3] %>)-1][1]
          c=rate[Math.round(2*<%= cookies[:asset_allocation].split('|')[3] %>)-1][2]
          d=rate[Math.round(2*<%= cookies[:asset_allocation].split('|')[3] %>)-1][3]
          $("#first").html("("+"<%= cookies[:asset_allocation].split('|')[3] %>"+")")
      <% end %>
    $("#f1").html(parseInt(a*100)+"%")
    $("#s1").html(parseInt(b*100)+"%")
    $("#t1").html(parseInt(c*100)+"%")
    $("#a1").html(parseInt(d*100)+"%")
    $("#f2").html("￥"+parseInt(a*50000))
    $("#s2").html("￥"+parseInt(b*50000))
    $("#t2").html("￥"+parseInt(c*50000))
    $("#a2").html("￥"+parseInt(d*50000))
    $("#amount-to-invest").val(50000)
    }
</script>
