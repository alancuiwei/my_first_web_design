<%= stylesheet_link_tag "personmanagement.css" %>

<div class="main-content organ">
  <a href="/">首页</a>
  <h1><%= @webuser.company %>&nbsp;<%= @webuser.division %>&nbsp;<%= @webuser.username %></h1>
  <h2>1. 产品管理</h2>
  <table cellpadding="0" cellspacing="0" border="0" class="display table  table-striped table-bordered" id="organ">
    <thead><tr>
      <th>发行机构</th><th>产品名称</th><th>年化收益率</th>
      <th>是否保本</th><th>起售价</th><th>理财期限</th>
      <th>起购日期</th><th>结束日期</th>
    </tr></thead>

    <% @bankfinances.each do |b| %>
        <tr>
          <td><%= b.trustee%></td>
          <td><%= b.bname%></td>
          <td><%= format("%0.1f",b.returnrate*100)%>%</td>
          <td><%= b.btype%></td>
          <td><%= b.startvalue%></td>
          <td><%= b.investperiod%></td>
          <td><%= b.sailsstart%></td>
          <td><%= b.collectperiod%></td>
        </tr>
    <% end %>
  </table>
  <h2>2. 家庭理财规划方案提供</h2>
  <table class="table table-striped table-bordered" id="invsetor">
    <thead>
    <tr>
      <th>会员名</th><th>资金量</th>
      <th>股票</th><th>基金</th><th>保险</th><th>商品期货</th><th>银行理财产品</th>
      <th class="hide">感兴趣的产品</th><th class="hide">会员名</th><th>信托产品</th><th class="hide">信托</th>
      <% if session[:webusername]==@webuser.username %>
          <th>操作</th>
      <% end %>
    </tr></thead>

    <% @personalfinance.each do |b| %>
        <tr>
          <td class="white"><a href="/personmanagement/personfinance/<%= b.id%>"><%= b.username%></a></td>
          <td class="white"></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td class="hide"><%= b.wbreedinfo%></td>
          <td class="hide"><%= b.username%></td>
          <td></td>
          <td class="hide"><%= b.contact%></td>
          <% if session[:webusername]==@webuser.username %>
              <td class="white"><a class="login-window" href="#login-box" id="<%= b.username%>">提供方案</a></td>
          <% end %>
        </tr>
    <% end %>
  </table>
  <h2>3. 咨询回答</h2>
  <p class="text2">标题：大家好，有什么资产配置、增值的问题，请尽管向我提问。</p>
  <% if @comments.length>0 %>
      <br><br>
      <table cellpadding="0" cellspacing="0" border="0" class="display" id="comments">
        <% @comments.each do |b| %>
            <tr>
              <td>
                <% if @webuser.username != b.username %>
                    <% if b.memberlevel=='1' %>
                        <p class="text2"><%= b.username%>(高级会员) 说：</p>
                    <% else %>
                        <p class="text2"><%= b.username%>(中级会员) 说：</p>
                    <% end %>
                <% else %>
                    <p class="text2"><%= b.username%>(来自<%= b.company%>) 说：</p>
                <% end %>
              </td>
            </tr>
            <tr>
              <td>
                <p class="text2"> <%= b.comments%> </p>
                <hr>
              </td>
            </tr>
        <% end %>
      </table>
  <% end %>
  <br>
  <form id="commentform">
    <p class="comment-form-comment"><label for="comment">评论</label>
      <textarea id="comment" name="comment" cols="45" rows="8" aria-required="true"></textarea></p>
    <a class="btn btn-primary" id="sub"  href="javascript:void(0)">发表</a>
    </p>
  </form>
</div>

<div id='login-box' class='login-popup'>
  <div class="popup">
    <a class="close" href="javascript:">×</a>
    <h1>提供方案<span class="hide" id="name"></span></h1>
    <table>
      <tr>
        <td>股票、基金：</td>
        <td>
          <div class="input-append">
            <input id="stock" type="text" title="股票、基金" name="stock">
            <span class="add-on">%</span>
          </div>
        </td>
      </tr>
      <tr>
        <td>国债、企业债：</td>
        <td>
          <div class="input-append">
            <input id="debt" type="text" title="国债、企业债" name="debt">
            <span class="add-on">%</span>
          </div>
        </td>
      </tr>
      <tr>
        <td>信托：</td>
        <td>
          <div class="input-append">
            <input id="trust" type="text" title="信托" name="trust">
            <span class="add-on">%</span>
          </div>
        </td>
      </tr>
      <tr>
        <td>银行理财产品：</td>
        <td>
          <div class="input-append">
            <input id="bankfinance" type="text" title="银行理财产品" name="bankfinance">
            <span class="add-on">%</span>
          </div>
        </td>
      </tr>
      <tr>
        <td colspan="2">
          <form id="myForm" action="" accept-charset="UTF-8"  enctype="multipart/form-data" method="post">
            <br>详细方案文档: <input id="file_file" name="file[file]" type="file"><br><br>
            <input name="commit" class="pull-right btn btn-primary" id="create" value="确定" type="submit">
          </form>
        </td>
      </tr>
    </table>
  </div>
</div>

<script >

    window.onload=function(){
        if(Request("comment")){
            $("#comment").html(Request("comment"));
        }
    }

    $("#sub").click(function(e){
        var nom_flag=0;
        var dateTime=new Date();
        var hh=dateTime.getHours();
        var mm=dateTime.getMinutes();
        var ss=dateTime.getSeconds();

        var yy=dateTime.getFullYear();
        var MM=dateTime.getMonth()+1;  //因为1月这个方法返回为0，所以加1
        var dd=dateTime.getDate();

        var week=dateTime.getDay();
        var days=[ "日 ", "一 ", "二 ", "三 ", "四 ", "五 ", "六 "]

//  var time=yy+"年"+MM+"月"+dd+"日 "+"星期"+days[week]+hh+"时"+mm+"分"+ss+"秒";
        var time=yy+"-"+MM+"-"+dd+" "+hh+":"+mm+":"+ss;

        if($('#comment').attr("value")==""){
            alert("评论为空！");
            nom_flag=1;
        }

        if('<%= session[:webusername] %>'=="" && nom_flag==0){
            location.href="/sales/login?comment="+$("#comment").attr("value")+'&wid='+'<%= @webuser.id%>';
            nom_flag=1;
        }

        var email=0;
        if('<%= session[:webusername] %>'!='<%= @webuser.username%>' &&  nom_flag==0){
            email=1;
        }

        if(nom_flag==0){
            $.post("/personmanagement/comment2configajax",{ username: '<%= session[:webusername] %>',email: '<%= @webuser.email%>',
                comment: $("#comment").attr("value"),wid: '<%= @webuser.id%>',time:time,memberlevel:'<%= @webuser2.memberlevel%>',
                company:'<%= @webuser2.company%>',email2: email,accept:'<%= @webuser.email%>',aid:'<%= @webuser.id%>'
            },function(data){
                if(data=="s1"){
                    location.reload();
                }
            });
        }
    });

    function Request(sName)
    {
        var sURL = new String(window.location);
        var sURL = document.location.href;
        sURL=decodeURI(sURL);
        var iQMark= sURL.lastIndexOf('?');
        var iLensName=sName.length;
        //retrieve loc. of sName
        var iStart = sURL.indexOf('?' + sName +'=') //limitation 1
        if (iStart==-1)
        {//not found at start
            iStart = sURL.indexOf('&' + sName +'=')//limitation 1
            if (iStart==-1)
            {//not found at end
                return 0; //not found
            }
        }

        iStart = iStart + + iLensName + 2;
        var iTemp= sURL.indexOf('&',iStart); //next pair start
        if (iTemp ==-1)
        {//EOF
            iTemp=sURL.length;
        }
        return sURL.slice(iStart,iTemp ) ;
        sURL=null;//destroy String
    }
</script>

<script>
    $(document).ready(function(){
        var length=$("#invsetor").find("tr").size();
        for(i=1;i<length;i++){
            var a3=0,a4=0,a5=0,a6=0,a7=0,a8=0;
            var b3=0,b4=0,b5=0,b6=0,b7=0,b8=0;
            var c3=0,c4=0,c5=0,c6=0,c7=0,c8=0;
        <% @personinvestinfo.each do |c| %>
            if ($("#invsetor tr:eq("+i+") td:eq(8)").html()=='<%= c.username %>' && '<%= c.producttype %>'=='股票'){
                a3=parseInt(a3+<%= c.investamount %>);
                if('<%= c.purchasproducts %>'=='已购' || '<%= c.purchasproducts %>'=='未购'){
                    b3='<%= c.purchasproducts %>'
                }
            }
            if ($("#invsetor tr:eq("+i+") td:eq(8)").html()=='<%= c.username %>' && '<%= c.producttype %>'=='基金'){
                a4=parseInt(a4+<%= c.investamount %>);
                if('<%= c.purchasproducts %>'=='已购' || '<%= c.purchasproducts %>'=='未购'){
                    b4='<%= c.purchasproducts %>'
                }
            }
            if ($("#invsetor tr:eq("+i+") td:eq(8)").html()=='<%= c.username %>' && '<%= c.producttype %>'=='保险'){
                a5=parseInt(a5+<%= c.investamount %>);
                if('<%= c.purchasproducts %>'=='已购' || '<%= c.purchasproducts %>'=='未购'){
                    b5='<%= c.purchasproducts %>'
                }
            }
            if ($("#invsetor tr:eq("+i+") td:eq(8)").html()=='<%= c.username %>' && '<%= c.producttype %>'=='商品期货'){
                a7=parseInt(a7+<%= c.investamount %>);
                if('<%= c.purchasproducts %>'=='已购' || '<%= c.purchasproducts %>'=='未购'){
                    b7='<%= c.purchasproducts %>'
                }
            }
            if ($("#invsetor tr:eq("+i+") td:eq(8)").html()=='<%= c.username %>' && '<%= c.producttype %>'=='银行理财产品'){
                a8=parseInt(a8+<%= c.investamount %>);
                if('<%= c.purchasproducts %>'=='已购' || '<%= c.purchasproducts %>'=='未购'){
                    b8='<%= c.purchasproducts %>'
                }
            }
        <% end %>
            if(b3=='已购'){
                if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("股票")>=0){
                    $("#invsetor tr:eq("+i+") td:eq(2)").addClass("yellow");
                }
                else{
                    $("#invsetor tr:eq("+i+") td:eq(2)").addClass("white");
                }
                a3='';
            }
            else if(b3=='未购'){$("#invsetor tr:eq("+i+") td:eq(2)").addClass("red");c3=a3;}
            else if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("股票")>=0){$("#invsetor tr:eq("+i+") td:eq(2)").addClass("yellow");a3=''}
            else{$("#invsetor tr:eq("+i+") td:eq(2)").addClass("white");a3=''}

            if(b4=='已购'){
                if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("基金")>=0){
                    $("#invsetor tr:eq("+i+") td:eq(3)").addClass("yellow");
                }
                else{
                    $("#invsetor tr:eq("+i+") td:eq(3)").addClass("white");
                }
                a4='';
            }
            else if(b4=='未购'){$("#invsetor tr:eq("+i+") td:eq(3)").addClass("red");c4=a4;}
            else if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("基金")>=0){$("#invsetor tr:eq("+i+") td:eq(3)").addClass("yellow");a4=''}
            else{$("#invsetor tr:eq("+i+") td:eq(3)").addClass("white");a4=''}

            if(b5=='已购'){
                if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("保险")>=0){
                    $("#invsetor tr:eq("+i+") td:eq(4)").addClass("yellow");
                }
                else{
                    $("#invsetor tr:eq("+i+") td:eq(4)").addClass("white");
                }
                a5='';
            }
            else if(b5=='未购'){$("#invsetor tr:eq("+i+") td:eq(4)").addClass("red");c5=a5;}
            else if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("保险")>=0){$("#invsetor tr:eq("+i+") td:eq(4)").addClass("yellow");a5=''}
            else{$("#invsetor tr:eq("+i+") td:eq(4)").addClass("white");a5=''}

            if(b7=='已购'){
                if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("商品期货")>=0){
                    $("#invsetor tr:eq("+i+") td:eq(5)").addClass("yellow");
                }
                else{
                    $("#invsetor tr:eq("+i+") td:eq(5)").addClass("white");
                }
                a7='';
            }
            else if(b7=='未购'){$("#invsetor tr:eq("+i+") td:eq(5)").addClass("red");c7=a7;}
            else if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("商品期货")>=0){$("#invsetor tr:eq("+i+") td:eq(5)").addClass("yellow");a7=''}
            else{$("#invsetor tr:eq("+i+") td:eq(5)").addClass("white");a7=''}

            if(b8=='已购'){
                if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("银行理财产品")>=0){
                    $("#invsetor tr:eq("+i+") td:eq(6)").addClass("yellow");
                }
                else{
                    $("#invsetor tr:eq("+i+") td:eq(6)").addClass("white");
                }
                a8='';
            }
            else if(b8=='未购'){$("#invsetor tr:eq("+i+") td:eq(6)").addClass("red");c8=a8;}
            else if($("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("银行理财产品")>=0){$("#invsetor tr:eq("+i+") td:eq(6)").addClass("yellow");a8=''}
            else{$("#invsetor tr:eq("+i+") td:eq(6)").addClass("white");a8=''}

            if( ($("#invsetor tr:eq("+i+") td:eq(10)").html()!='不感兴趣' && $("#invsetor tr:eq("+i+") td:eq(10)").html()!='') || $("#invsetor tr:eq("+i+") td:eq(7)").html().indexOf("信托")>=0){$("#invsetor tr:eq("+i+") td:eq(9)").addClass("yellow");}
            else{$("#invsetor tr:eq("+i+") td:eq(9)").addClass("white");}

            $("#invsetor tr:eq("+i+") td:eq(1)").html(parseInt(parseFloat(c3)+parseFloat(c4)+parseFloat(c5)+parseFloat(c7)+parseFloat(c8)))
            $("#invsetor tr:eq("+i+") td:eq(2)").html(a3)
            $("#invsetor tr:eq("+i+") td:eq(3)").html(a4)
            $("#invsetor tr:eq("+i+") td:eq(4)").html(a5)
            $("#invsetor tr:eq("+i+") td:eq(5)").html(a7)
            $("#invsetor tr:eq("+i+") td:eq(6)").html(a8)
        }
    });

    $('a.login-window').click(function() {
        $("#name").html(this.id);
        var loginBox = $(this).attr('href');
        //Fade in the Popup and add close button
        $(loginBox).fadeIn(300);
        //Set the center alignment padding + border
        var popMargTop = ($(loginBox).height() + 24) / 2;
        var popMargLeft = ($(loginBox).width() + 24) / 2;

        $(loginBox).css({
            'margin-top' : -popMargTop,
            'margin-left' : -popMargLeft
        });

        // Add the mask to body
        $('body').append('<div id="mask"></div>');
        $('#mask').fadeIn(300);

        return false;
    });

    // When clicking on the button close or the mask layer the popup closed
    $('a.close, #mask').live('click', function() {
        $('#mask , .login-popup').fadeOut(300 , function() {
            $('#mask').remove();
        });
        return false;
    });

    function getFileName(path){
        var pos1 = path.lastIndexOf('/');
        var pos2 = path.lastIndexOf('\\');
        var pos  = Math.max(pos1, pos2)
        if( pos<0 )
            return path;
        else
            return path.substring(pos+1);
    }

    $('#create').click(function() {
        var o=document.getElementsByTagName("input");
        var nom_flag=0;
        var numfor=/^[-+]?[0-9]+(\.[0-9]+)?$/;
        for(var i=0;i<o.length;i++)
        {
            if(o[i].value=="" && o[i].title!=""){
                alert(o[i].title+"为空！");
                return false;
                nom_flag=1;
                break;
            }
            else if(numfor.test(o[i].value)==false && o[i].title!=""){
                alert(o[i].title+"必须为数字！");
                return false;
                nom_flag=1;
                break;
            }
        }

        if(nom_flag==0){
            var a=0;
            for(var i=0;i<o.length;i++)
            {
                if(o[i].title!=""){
                    a=parseFloat(a)+parseFloat(o[i].value)
                }
            }
            if(a>100){
                alert("和不能超过100%！")
                return false;
                nom_flag=1;
            }
        }
        if(document.getElementById('file_file').value==''){
            alert('请选择您所要上传的图片');
            return false;
            nom_flag=1;
        }
        else if(nom_flag==0){
            document.getElementById('myForm').action = "/personmanagement/create?username="+$("#name").html()+"&managename=<%= session[:webusername] %>&stock="+String($("#stock").attr("value")/100)+"&debt="
                           +String($("#debt").attr("value")/100)+"&trust="+String($("#trust").attr("value")/100)+"&bankfinance="+String($("#bankfinance").attr("value")/100)+"&filename="+getFileName(document.getElementById("file_file").value);
            document.getElementById("myForm").submit();
        }
    });
</script>