<%= stylesheet_link_tag "personmanagement.css" %>
<%= stylesheet_link_tag "bootstrap.min.css" %>
<%= javascript_include_tag "bootstrap.min.js" %>
<style>
    body {
        background: none repeat scroll 0% 0% rgb(243, 243, 233)!important;
    }
</style>
<% if @webuser.username==session[:webusername] %>
    <style>
        #organ td, #organ th {
            width: 11.1%;
        }
    </style>
<% end %>

<div class="main-content organ">
  <a href="/">首页</a>
  <% if @webuser.username==session[:webusername] %>
      <h1 style="margin: 20px 0 40px;"><%= @webuser.company %>&nbsp;<%= @webuser.trade %>&nbsp;<%= @webuser.name %>&nbsp;管理页面</h1>
  <% else %>
      <h1 style="margin: 20px 0 40px;"><%= @webuser.company %>&nbsp;<%= @webuser.division %>&nbsp;<%= @webuser.username %></h1>
  <% end %>
  <!--
  <h2>1. 介绍</h2>
  <div id="myCarousel" class="carousel slide">
    <ol class="carousel-indicators">
      <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
      <li data-target="#myCarousel" data-slide-to="1" class=""></li>
      <li data-target="#myCarousel" data-slide-to="2" class=""></li>
      <li data-target="#myCarousel" data-slide-to="3" class=""></li>
    </ol>
    <div class="carousel-inner">
      <div class="item active" style="padding: 0 85px;height: 470px;">
        <img src="/assets/120099.jpg" alt="" style="margin: 0 auto;max-height: 470px;">
      </div>
      <div class="item" style="padding: 0 85px;height: 470px;">
        <img src="/assets/120098.jpg" alt="" style="margin: 0 auto;max-height: 470px;">
      </div>
      <div class="item" style="padding: 0 85px;height: 470px;">
        <img src="/assets/120097.jpg" alt="" style="margin: 0 auto;max-height: 470px;">
      </div>
      <div class="item" style="padding: 0 85px;height:470px;">
        <img src="/assets/120096.jpg" alt="" style="margin: 0 auto;max-height: 470px;">
      </div>
    </div>
    <a class="left carousel-control" href="#myCarousel" data-slide="prev">‹</a>
    <a class="right carousel-control" href="#myCarousel" data-slide="next">›</a>
  </div>
  <div style="display: table;width: 100%;" class="applies">
    <a href="/usersurvey/freeapply" class="btn btn-primary pull-right" style="margin-right: 22.2%;" target="_blank">免费申请</a>
    <a class="pull-right" style="padding-right:10px;line-height: 52px;" href="/home/download/data?filename=理财师VIP服务.ppt">PPT下载</a>
  </div>
  -->
  <h2>1. 规划书客户</h2>
  <table class="table table-striped table-bordered" id="invsetor">
    <thead>
    <tr>
      <th>会员名</th><th>省份</th>
      <th>城市</th><th>梦想</th><th>梦想价值</th><th>已有存款</th>
      <th>每月存款</th><th>实现时间</th>
      <% if session[:webusername]==@webuser.username %>
          <th>操作</th>
      <% end %>
    </tr></thead>
    <% for i in 0..@webusers.size-1 %>
        <tr>
          <td><a href="/personmanagement/personfinance/<%= @webusers[i].id %>"><%= @webusers[i].username %></a></td>
          <td><%= @webusers[i].province %></td>
          <td><%= @webusers[i].city %></td>
          <td><%= @webusers[i].dream %></td>
          <td><%= @webusers[i].amount %></td>
          <td><%= @hash[@webusers[i].username][0] %></td>
          <td><%= @webusers[i].monthpay %></td>
          <td><%= @webusers[i].realizetime %></td>
          <% if session[:webusername]==@webuser.username %>
              <% if @hash[@webusers[i].username][1]!=1 %>
                  <td class="white"><a class="login-window" href="#login-box" id="<%= @webusers[i].username %>">提供方案</a></td>
              <% else %>
                  <td class="white">已提供</td>
              <% end %>
          <% end %>
        </tr>
    <% end %>
  </table>
  <% if @webuser.username==session[:webusername] %>
      <h2>2. 产品管理<span style="float: right;font-size: 14px;font-weight: normal;width: 116px;"><a href="/admin/bankfinanceconfig/0?organ=1">添加产品</a></span></h2>
  <% else %>
      <h2>2. 产品管理</h2>
  <% end %>
  <table cellpadding="0" cellspacing="0" border="0" class="display table  table-striped table-bordered" id="organ">
    <thead><tr>
      <th>发行机构</th><th>产品名称</th><th>年化收益率</th>
      <th>是否保本</th><th>起售价</th><th>理财期限</th>
      <th>起购日期</th><th>结束日期</th>
      <% if @webuser.username==session[:webusername] %>
          <th>更多</th>
      <% end %>
    </tr></thead>

    <% @bankfinances.each do |b| %>
        <tr>
          <td><%= b.trustee%></td>
          <td><%= b.bname%></td>
          <td><%= format("%0.1f",b.returnrate*100)%>%</td>
          <td><%= b.btype%></td>
          <td><%= b.startvalue%></td>
          <td><%= b.investperiod%></td>
          <td><%= b.sailsstart%></td>
          <td><%= b.collectperiod%></td>
          <% if @webuser.username==session[:webusername] %>
              <td><a href="/admin/bankfinanceconfig/<%= b.id %>?optype=edit&organ=1">修改</a></td>
          <% end %>
        </tr>
    <% end %>
  </table>
  <!--
  <h2>4. 咨询回答</h2>
  <p class="text2">标题：大家好，有什么资产配置、增值的问题，请尽管向我提问。</p>
  <% if @comments.length>0 %>
      <br><br>
      <table cellpadding="0" cellspacing="0" border="0" class="display" id="comments">
        <% @comments.each do |b| %>
            <tr>
              <td>
                <% if @webuser.username != b.username %>
                    <% if b.memberlevel=='1' %>
                        <p class="text2"><%= b.username%>(高级会员) 说：</p>
                    <% else %>
                        <p class="text2"><%= b.username%>(中级会员) 说：</p>
                    <% end %>
                <% else %>
                    <p class="text2"><%= b.username%>(来自<%= b.company%>) 说：</p>
                <% end %>
              </td>
            </tr>
            <tr>
              <td>
                <p class="text2"> <%= b.comments%> </p>
                <hr>
              </td>
            </tr>
        <% end %>
      </table>
  <% end %>
  <br>
  <form id="commentform">
    <p class="comment-form-comment"><label for="comment">评论</label>
      <textarea id="comment" name="comment" cols="45" rows="8" aria-required="true"></textarea></p>
    <a class="btn btn-primary" id="sub"  href="javascript:void(0)">发表</a>
    </p>
  </form>
   -->
</div>

<div id='login-box' class='login-popup'>
  <div class="popup">
    <a class="close" href="javascript:">×</a>
    <h1>提供方案<span class="hide" id="name"></span></h1>
    <table>
      <tr>
        <td>货币基金：</td>
        <td>
          <div class="input-append">
            <input id="stock" type="text" title="货币基金" name="stock">
            <span class="add-on">%</span>
          </div>
        </td>
      </tr>
      <tr>
        <td>债券基金：</td>
        <td>
          <div class="input-append">
            <input id="debt" type="text" title="债券基金" name="debt">
            <span class="add-on">%</span>
          </div>
        </td>
      </tr>
      <tr>
        <td>指数基金：</td>
        <td>
          <div class="input-append">
            <input id="trust" type="text" title="指数基金" name="trust">
            <span class="add-on">%</span>
          </div>
        </td>
      </tr>
      <tr>
        <td>银行理财产品：</td>
        <td>
          <div class="input-append">
            <input id="bankfinance" type="text" title="银行理财产品" name="bankfinance">
            <span class="add-on">%</span>
          </div>
        </td>
      </tr>
      <tr>
        <td colspan="2">
          <form id="myForm" action="" accept-charset="UTF-8"  enctype="multipart/form-data" method="post">
            <br>详细方案文档: <input id="file_file" name="file[file]" type="file"><br><br>
            <input name="commit" class="pull-right btn btn-primary" id="create" value="确定" type="submit">
          </form>
        </td>
      </tr>
    </table>
  </div>
</div>

<script >

    window.onload=function(){
        if(Request("comment")){
            $("#comment").html(Request("comment"));
        }
    }

    $("#sub").click(function(e){
        var nom_flag=0;
        var dateTime=new Date();
        var hh=dateTime.getHours();
        var mm=dateTime.getMinutes();
        var ss=dateTime.getSeconds();

        var yy=dateTime.getFullYear();
        var MM=dateTime.getMonth()+1;  //因为1月这个方法返回为0，所以加1
        var dd=dateTime.getDate();

        var week=dateTime.getDay();
        var days=[ "日 ", "一 ", "二 ", "三 ", "四 ", "五 ", "六 "]

//  var time=yy+"年"+MM+"月"+dd+"日 "+"星期"+days[week]+hh+"时"+mm+"分"+ss+"秒";
        var time=yy+"-"+MM+"-"+dd+" "+hh+":"+mm+":"+ss;

        if($('#comment').attr("value")==""){
            alert("评论为空！");
            nom_flag=1;
        }

        if('<%= session[:webusername] %>'=="" && nom_flag==0){
            location.href="/sales/login?comment="+$("#comment").attr("value")+'&wid='+'<%= @webuser.id%>';
            nom_flag=1;
        }

        var email=0;
        if('<%= session[:webusername] %>'!='<%= @webuser.username%>' &&  nom_flag==0){
            email=1;
        }

        if(nom_flag==0){
            $.post("/personmanagement/comment2configajax",{ username: '<%= session[:webusername] %>',email: '<%= @webuser.email%>',
                comment: $("#comment").attr("value"),wid: '<%= @webuser.id%>',time:time,memberlevel:'<%= @webuser2.memberlevel%>',
                company:'<%= @webuser2.company%>',email2: email,accept:'<%= @webuser.email%>',aid:'<%= @webuser.id%>'
            },function(data){
                if(data=="s1"){
                    location.reload();
                }
            });
        }
    });

    function Request(sName)
    {
        var sURL = new String(window.location);
        var sURL = document.location.href;
        sURL=decodeURI(sURL);
        var iQMark= sURL.lastIndexOf('?');
        var iLensName=sName.length;
        //retrieve loc. of sName
        var iStart = sURL.indexOf('?' + sName +'=') //limitation 1
        if (iStart==-1)
        {//not found at start
            iStart = sURL.indexOf('&' + sName +'=')//limitation 1
            if (iStart==-1)
            {//not found at end
                return 0; //not found
            }
        }

        iStart = iStart + + iLensName + 2;
        var iTemp= sURL.indexOf('&',iStart); //next pair start
        if (iTemp ==-1)
        {//EOF
            iTemp=sURL.length;
        }
        return sURL.slice(iStart,iTemp ) ;
        sURL=null;//destroy String
    }
</script>

<script>
    $('a.login-window').click(function() {
        $("#name").html(this.id);
        var loginBox = $(this).attr('href');
        //Fade in the Popup and add close button
        $(loginBox).fadeIn(300);
        //Set the center alignment padding + border
        var popMargTop = ($(loginBox).height() + 24) / 2;
        var popMargLeft = ($(loginBox).width() + 24) / 2;

        $(loginBox).css({
            'margin-top' : -popMargTop,
            'margin-left' : -popMargLeft
        });

        // Add the mask to body
        $('body').append('<div id="mask"></div>');
        $('#mask').fadeIn(300);

        return false;
    });

    // When clicking on the button close or the mask layer the popup closed
    $('a.close, #mask').live('click', function() {
        $('#mask , .login-popup').fadeOut(300 , function() {
            $('#mask').remove();
        });
        return false;
    });

    function getFileName(path){
        var pos1 = path.lastIndexOf('/');
        var pos2 = path.lastIndexOf('\\');
        var pos  = Math.max(pos1, pos2)
        if( pos<0 )
            return path;
        else
            return path.substring(pos+1);
    }

    $('#create').click(function() {
        var o=document.getElementsByTagName("input");
        var nom_flag=0;
        var numfor=/^[-+]?[0-9]+(\.[0-9]+)?$/;
        for(var i=0;i<o.length;i++)
        {
            if(o[i].value=="" && o[i].title!=""){
                alert(o[i].title+"为空！");
                return false;
                nom_flag=1;
                break;
            }
            else if(numfor.test(o[i].value)==false && o[i].title!=""){
                alert(o[i].title+"必须为数字！");
                return false;
                nom_flag=1;
                break;
            }
        }

        if(nom_flag==0){
            var a=0;
            for(var i=0;i<o.length;i++)
            {
                if(o[i].title!=""){
                    a=parseFloat(a)+parseFloat(o[i].value)
                }
            }
            if(a!=100){
                alert("比例之和须为100%！")
                return false;
                nom_flag=1;
            }
        }
        if(document.getElementById('file_file').value==''){
            alert('请选择您所要上传的文件');
            return false;
            nom_flag=1;
        }
        else if(nom_flag==0){
            document.getElementById('myForm').action = "/personmanagement/create?username="+$("#name").html()+"&managename=<%= session[:webusername] %>&stock="+String($("#stock").attr("value")/100)+"&debt="
                           +String($("#debt").attr("value")/100)+"&trust="+String($("#trust").attr("value")/100)+"&bankfinance="+String($("#bankfinance").attr("value")/100)+"&filename="+getFileName(document.getElementById("file_file").value)
                           +"&company=<%= @webuser2.company %>";
            document.getElementById("myForm").submit();
        }
    });
</script>