<%= stylesheet_link_tag "common2.css" %>
<%= javascript_include_tag "highcharts.js" %>
<%= stylesheet_link_tag "p1_usersurvey.css" %>
<%= javascript_include_tag "bootstrap.min.js" %>

<style type="text/css">
     .table th, .table td {
        text-align: center;
        vertical-align: middle!important;
    }
</style>

<div class="welcomes start goal">
  <div id="page-content">
    <h1>您的理财目标</h1>
    <div class="tablet">
      <div class="row-fluid">
        <div class="span1">
          <span>1</span>
        </div>
        <div class="span11">
          <h2>您的目标概述：</h2>
          <div class="mleft">
            <div class="left">
              <table id="target" class="table table-striped table-bordered">
                <thead>
                <tr><th>目标描述</th><th>现需资金</th><th>实现所需年限</th><th>属性</th><th>到期所需资金</th><th>每年投入</th><th>每月投入</th><th>需要投资报酬率</th></tr>
                </thead>
                <% if @targets!=nil %>
                    <tr class="goals">
                      <td><%= @targets.user_target %></td>
                      <td><%= @targets.user_target_value %>万</td>
                      <td><%= @targets.user_target_period %>年</td>
                      <td>
                        <% if @targets.user_target_period<=2 %>
                            短期
                        <% elsif @targets.user_target_period<=5 %>
                            中期
                        <% else %>
                            长期
                        <% end %>
                      </td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                    </tr>
                <% end %>
                <tr></tr>
              </table>
              <blockquote><small class="intro">上表基于如下假设：<span>通货膨胀率 6%</span><span>投资回报率 4%-10%</span><span>退休后净报酬率 2%</span><span>学费增长率 6%</span><span>薪资成长率 5%</span><span>退休金增长率 3%</span><span>社会平均寿命： 80岁</span></small></blockquote>
            </div>
            <div style="display: table;width: 100%;"><a class="introduce pull-right" href="/usertargets/p2s1_user_target_select">修改理财目标</a></div>
          </div>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span1">
          <span>2</span>
        </div>
        <div class="span11">
          <h2>目标实现准备：</h2>
          <div class="mleft">
            <p class="q-text" id="intro"></p>
            <div class="left">
              <table id="calculate" class="table table-striped table-bordered"></table>
              <a id="tnext" class="pull-right">下一页</a><a id="tback" class="pull-right grey" name="0">上一页</a>
              <div id="container" style="width: 100%;height: 300px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="q-buttons" class="">
      <button class="q-button light-gray big-button" id="q-back">◄&nbsp; <span>上一题</span>&nbsp;</button>
      <button class="q-button orange-button big-button" id="q-next">风险评估</button>
    </div>
  </div>

  <div id="myModal8" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3>计算过程</h3>
    </div>
    <div class="modal-body">
      <table id="compute" class="table table-striped table-bordered">
        <thead><tr><th>年数</th><th>通货膨胀下实际所需资金量</th></tr></thead>
        <tbody id="newbody"></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">确认</button>
    </div>
  </div>
</div>

<script>
    var count=new Array();
    $(document).ready(function(){
        $(".goals td:eq(4)").html(parseInt(parseInt(<%= @targets.user_target_value %>)*10000*Math.pow(1.06,<%= @targets.user_target_period %>))+" <a href='#myModal8' role='button' data-toggle='modal' onclick='model()'>(?)</a>");
        $(".goals td:eq(5)").html(<%= @annual %>);
        $(".goals td:eq(6)").html(<%= @month %>);
        for(var k=1;k<=parseInt(<%= @targets.user_target_period %>);k++){
            count[k]=parseInt(parseInt(<%= @targets.user_target_value %>)*10000*Math.pow(1.06,k))
        }

        var x=100,y=0;
        while(Math.abs(x-y)>Math.pow(0.1,7)){
            var z=parseFloat(x+y)/2
            if(parseInt(<%= @annual %>)*(1+z)*(Math.pow(1+z,<%= @targets.user_target_period %>)-1)/z+parseInt(<%= @income %>)*Math.pow(1+z,<%= @targets.user_target_period %>)>parseInt(parseInt(<%= @targets.user_target_value %>)*10000*Math.pow(1.06,<%= @targets.user_target_period %>))){
                x=z
            }
            else{
                y=z
            }
        }
        $(".goals td:eq(7)").html((x*100).toFixed(2)+'%');


        $("#intro").html("您的目标是<%= @targets.user_target %>，您将需要在<%= @targets.user_target_period %>年后准备"+parseInt(parseInt(<%= @targets.user_target_value %>)*10000*Math.pow(1.06,parseInt(<%= @targets.user_target_period %>)))+"元，您现在的已有的资金为<%= @targets.user_target_value %>万，之后，您每年将投入资金<%= @annual %>元，如果您能找到年收益率为"+(x*100).toFixed(2)+"%左右的投资渠道，您将能在<%= @targets.user_target_period %>年后实现您的目标。")
        var array=new Array();
        var today=new Date();
        var year=today.getFullYear();
        for(var k=0;k<parseInt(<%= @targets.user_target_period %>)+2;k++){
            array[k]=new Array();
            if(k>0){
                array[k][0]=parseInt(year)+k-1
            }
        }
        array[0][0]="";
        array[0][1]="已有资金";
        array[0][parseInt(<%= @targets.user_target_period %>)+2]="总计";
        for(m=0;m<parseInt(<%= @targets.user_target_period %>)+3;m++){
            if(m>=2 && m<parseInt(<%= @targets.user_target_period %>)+2){
                array[0][m]="第"+(m-1).toString()+"年";
            }
            if(m>=1 && m<=parseInt(<%= @targets.user_target_period %>)+2){
                for(var k=1;k<parseInt(<%= @targets.user_target_period %>)+2;k++){
                    if(m==parseInt(<%= @targets.user_target_period %>)+2){
                        array[k][m]=0;
                        for(n=1;n<parseInt(<%= @targets.user_target_period %>)+2;n++){
                            if(array[k][n]!="-"){
                                array[k][m]=array[k][m]+array[k][n]
                            }
                        }
                    }
                    else{
                        if(m==1){
                            array[k][m]=parseInt(<%= @income %>)*Math.pow(1+z,k-m)
                        }
                        else{
                            if(k<m-1){array[k][m]="-"}
                            else{
                                array[k][m]=parseInt(<%= @annual %>)*Math.pow(1+z,k-m+1)
                            }
                        }
                    }
                }
            }
        }

        var text="<thead><tr><th></th><th>投入本金</th><th>"+array[parseInt(<%= @targets.user_target_period %>)+1][0]+"年的回报金额</th></thead>"
        text=text+'<tr><td>总计</td><td>'+(parseInt(<%= @income %>)+parseInt(<%= @annual %>)*parseInt(<%= @targets.user_target_period %>)).toString()+"</td><td>"+parseInt(array[parseInt(<%= @targets.user_target_period %>)+1][parseInt(<%= @targets.user_target_period %>)+2])+"</td></tr>"
        for(m=1;m<parseInt(<%= @targets.user_target_period %>)+2;m++){
            if(m==1){
                text=text+"<tr><td>"+array[0][m]+"</td><td><%= @income %></td><td>"+parseInt(array[parseInt(<%= @targets.user_target_period %>)+1][m])+"</td></tr>"
            }
            else if(m>7){
                text=text+"<tr class='hide'><td>"+array[0][m]+"</td><td><%= @annual %></td><td>"+parseInt(array[parseInt(<%= @targets.user_target_period %>)+1][m])+"</td></tr>"
            }
            else{
                text=text+"<tr><td>"+array[0][m]+"</td><td><%= @annual %></td><td>"+parseInt(array[parseInt(<%= @targets.user_target_period %>)+1][m])+"</td></tr>"
            }
        }
        if(parseInt(<%= @targets.user_target_period %>)<=6){
            $("#tback,#tnext").addClass("grey");
        }
        $("#calculate").html(text);
        var dataarray=new Array();
        var dataarray1=new Array();
        for(var k=1;k<parseInt(<%= @targets.user_target_period %>)+2;k++){
            dataarray.push(array[k][0]);
            dataarray1.push(parseInt(array[k][parseInt(<%= @targets.user_target_period %>)+2]));
        }

        var chart = new Highcharts.Chart({
            chart: {
                renderTo: 'container',
                type: 'column'
            },
            title: {
                text: false
            },
            subtitle: {
                text: false
            },
            xAxis: {
                categories: dataarray ,
                labels: {
                    rotation: -45,
                    align: 'right',
                    style: {
                        fontSize: '13px',
                        fontFamily: 'Verdana, sans-serif'
                    }
                }
            },
            yAxis: {
                min: 0,
                title: {
                    text: '回报金额'
                },
                labels:{
                    formatter: function() {
                        return this.value
                    }
                }
            },
            legend: {
                enabled: false
            },
            tooltip: {
                pointFormat: '{point.y} '
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                data: dataarray1
            }],
            credits: {
                enabled: false
            }
        });
    });
    function model(e){
        var text="<tr><td></td><td>6%</td></tr>"
        for(var i=1;i<count[e].length;i++){
            text=text+"<tr><td>"+i+"</td>"+"<td>"+count[e][i]+"</td></tr>"
        }
        $("#newbody").html(text);
    }
</script>

<script>

    $("#tback,#tnext").click(function(){
        var length=$("#calculate tbody").find("tr").size();
        var total= Math.ceil(length/8);
        var page=parseInt($("#tback").attr("name"));
        if(this.id=="tnext"){
            if(page<total-1){
                page=page+1
            }
        }
        else if(this.id=="tback"){
            if(page>0){
                page=page-1;
            }
        }
        if(total<=1){
            $("#tback,#tnext").addClass("grey");
        }
        else if(page==0){
            $("#tback").addClass("grey");
            $("#tnext").removeClass("grey");
        }
        else if(page==total-1){
            $("#tback").removeClass("grey");
            $("#tnext").addClass("grey");
        }
        else{
            $("#tback,#tnext").removeClass("grey");
        }
        $("#tback").attr("name",page);
        $("#calculate tbody tr").addClass("hide");
        for(i=page*8;i<(page+1)*8;i++){
            $("#calculate tbody tr:eq("+i+")").removeClass("hide");
        }
    });

    $("#q-back").click(function(){
       location.href="/usertargets/p2s1_user_target_select";
    });
    $("#q-next").click(function(){
        location.href='/home/questions';
    });

</script>