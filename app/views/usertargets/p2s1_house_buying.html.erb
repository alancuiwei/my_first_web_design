<%= stylesheet_link_tag "usermanagement.css" %>
<%= stylesheet_link_tag "p2s1.css" %>
<%= javascript_include_tag "bootstrap.min.js" %>

<div class="main-content">
<div class="trow">
<div class="main-inputs">
  <div id="inputs" class="content">
    <div id="inputs-container">
      <div class="padded">
        <h3>关于您的信息</h3>
        <p>掌握您部分的信息，我们将能给您更加准确、实际的家庭理财建议。</p>
        <p>我们不会泄露您的个人信息，因为我们并不知道您是谁，对吧。</p>
      </div>
      <div id="main-inputs" style="">
        <div class="general">
          <div class="input-group active custom" id="inputs-income">
            <label for="input-income-field">购房类型</label>
            <select id="buy_house_type" onChange='housetype()'>
               <option value="0">新房</option>
               <option value="1">二手房</option>
            </select>
          </div>
          <div class="input-group active custom" id="inputs-downpayment">
            <label for="input-downpayment-field">购房面积(平方米)</label>
            <input class="span2e" id="buy_house_area" value="" size="0" type="text" onkeyup="housearea()">
          </div>
          <div class="input-group active custom" id="inputs-debtpayments">
            <label for="input-debtpayments-field">购房单价</label>
            <div class="controls">
              <div class="input-prepend">
                <span class="add-on">￥</span>
                <input class="span2e" value="" id="buy_house_uint_prince" size="16" type="text" readonly>
              </div>
            </div>
          </div>
          <div class="input-group active custom" id="inputs-credit">
            <label for="input-credit-field">购房性质</label>
            <select id="buy_house_attribute">
              <option value="0">家庭唯一一套住宅</option>
              <option value="1">非家庭唯一一套住宅</option>
            </select>
          </div>
          <div class="last input-group active custom inputs-location hide">
            <label for="input-location-field">几年内转让</label>
            <select id="house_sell_years">
              <option value="0">5年内</option>
              <option value="1">5年后</option>
            </select>
          </div>
          <div class="last input-group active custom inputs-location hide">
            <label for="input-location-field">是否首次购房</label>
            <select id="is_first_house">
              <option value="0">不是</option>
              <option value="1">是</option>
            </select>
          </div>
          <div class="last input-group active custom">
             <a class="btn btn-primary" style="margin: 5px 0 5px 110px;" id="savehouse">保存</a>
          </div>
        </div>
      </div>
    </div>
    <div id="advanced-settings">
      <div class="button">
        <a href="#myModal" role="button" data-toggle="modal"><img src="/assets/cogs.png">高级设置</a>
      </div>
    </div>
  </div>
</div>
<div class="main-body">
<h1>我能承受多少价格的房子</h1>
<div class="page-interaction">
  <div class="interaction-content">
    <div class="ispacer">
      <table class="block">
        <tbody>
        <tr>
          <td rowspan="3" width="280px">
            <h4 class="spaced">房子价格</h4>
            <input class="value editvalue homev large" id="display-hv" value="￥<%= (@downpayment/0.3).to_i %>" style="color: rgb(103, 169, 83); ">
            <div id="hm-icon" class="home-icon hsprite-green"> </div>
          </td>
          <td class="bleft bbottom arrow">
            <div class="arrow">
              <div class="arrow-content"> </div>
            </div>
          </td>
          <td class="bbottom">
            <h4 style="text-align: left; margin-bottom: 10px">首付房款</h4>
            <table class="sub">
              <tbody>
              <tr>
                <td class="bright" align="right" width="130px">
                  <input class="value right editvalue" linked-slider="slider-downpayment" id="display-dp" value="￥<%= @downpayment %>" style="margin-top: -20px; color: rgb(103, 169, 83); ">
                  <a href='javascript:hwEdit("#display-dp")' class="tiny">修改</a>
                  <div id="slider-downpayment">
                    <button id="rate-decrease" class="light-gray" tabindex="-1">−</button>
                    <input id="downpaymentrate" value="30" type="text" style="width: 160px;margin: 0;text-align: center;" readonly>
                    <button id="rate-increase" class="light-gray" tabindex="-1">+</button>
                  </div>
                  <div class="subtext">
                    <b id="display-sub-dp">30%</b> 首付比例</div>
                </td>
                <td width="40%" class="totals" style="height: 130px;">
                  <h4>首付实际资金</h4>
                  <div class="spacer s5"></div>
                  <table class="totals">
                    <tbody>
                    <tr>
                      <td>房款首付</td>
                      <td class="bold right" id="display-shoufu" style="color: rgb(103, 169, 83); ">￥<%= @downpayment %></td>
                    </tr>
                    <tr>
                      <td>住房维修基金</td>
                      <td class="bold right" id="display-jijin"></td>
                    </tr>
                    <tr>
                      <td>契税</td>
                      <td class="bold right" id="display-qishui"></td>
                    </tr>
                    <tr class="last">
                      <td class="total right" colspan="2"><b id="display-ctotal" style="color: rgb(103, 169, 83); "></b></td>
                    </tr>
                    </tbody>
                  </table>
                </td>
              </tr>
              </tbody>
            </table>
          </td>
        </tr>
        <tr>
          <td class="bleft arrow">
            <div class="arrow">
              <div class="arrow-content"> </div>
            </div>
          </td>
          <td class="bbottom">
            <h4 style="text-align: left; margin-bottom: 10px">公积金贷款</h4>
            <table class="sub">
              <tbody>
              <tr>
                <td class="bright" align="right" width="60%">
                  <input class="value right editvalue" linked-slider="slider-mortgage" id="display-mv" value="￥100000" style="margin-top: -20px; color: rgb(103, 169, 83); ">
                  <a href='javascript:hwEdit("#display-mv")' class="tiny">修改</a>
                  <table class="slider" style="margin-top: 0px">
                    <tbody>
                    <tr>
                      <td width="50%">按揭年数</td>
                      <td><select id="years"><option value="20年">20年</option></select></td>
                    </tr>
                    <tr>
                      <td width="50%">贷款利率</td>
                      <td><select id="years"><option value="12年7月6日利率下线(1.1倍)">12年7月6日利率下线(1.1倍)</option></select></td>
                    </tr>
                    </tbody>
                  </table>
                </td>
                <td width="40%" class="totals">
                  <h4></h4>
                  <div class="spacer s5"></div>
                  <table class="totals">
                    <tbody>
                    <tr>
                      <td>本人公积金月供</td>
                      <td class="right"><b class="monthly_public_fund_house" style="color: rgb(103, 169, 83); ">￥2000</b>/月</td>
                    </tr>
                    <tr>
                      <td>配偶公积金月供</td>
                      <td class="right"><b class="spouse_monthly_public_fund_house">￥2000</b>/月</td>
                    </tr>
                    <tr class="last">
                      <td class="total right" colspan="2">
                        <b id="display-mtotal" style="color: rgb(103, 169, 83); ">￥4000</b>/月
                      </td>
                    </tr>
                    </tbody>
                  </table>
                </td>
              </tr>
              </tbody>
            </table>
          </td>
        </tr>
        <tr>
          <td class="bleft arrow">
            <div class="arrow">
              <div class="arrow-content"> </div>
            </div>
          </td>
          <td class="">
            <h4 style="text-align: left; margin-bottom: 10px">商业贷款</h4>
            <table class="sub">
              <tbody>
              <tr>
                <td class="bright" align="right" width="60%">
                  <input class="value right editvalue" linked-slider="slider-mortgage" id="display-mv" value="￥600000" style="margin-top: -20px; color: rgb(103, 169, 83); ">
                </td>
                <td width="40%" class="totals">
                  <h4></h4>
                  <div class="spacer s5"></div>
                  <table class="totals">
                    <tbody>
                    <tr>
                      <td>贷款总额</td>
                      <td class="right"><b id="display-mrepay" style="color: rgb(103, 169, 83); ">￥600000</b></td>
                    </tr>
                    <tr>
                      <td>支付利息额</td>
                      <td class="right"><b id="display-mother">￥454000</b></td>
                    </tr>
                    <tr class="total last">
                      <td>总还款金额</td>
                      <td class="right"><b class="display-mtotal" style="color: rgb(103, 169, 83); ">￥1054000</b></td>
                    </tr>
                    <tr class="last">
                      <td>贷款月数</td>
                      <td class="right"><b class="display-mtotal" style="color: rgb(103, 169, 83); ">240</b>(月)</td>
                    </tr>
                    <tr class="last">
                      <td>月均还款</td>
                      <td class="right"><b class="display-mtotal" style="color: rgb(103, 169, 83); ">￥3000</b>/月</td>
                    </tr>
                    </tbody>
                  </table>
                </td>
              </tr>
              </tbody>
            </table>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<div class="spacer s15"></div>
<div class="page-details page-data">
  <h3 class="title">家庭收入、贷款、月供信息</h3>
  <div class="clearfix">
    <div class="additional-content">
      <table>
        <tbody>
        <tr>
          <td>
            <div id="debt-indicator" class="error-icon large" style="margin-bottom:14px;"></div>
          </td>
          <td>
            <h2>月贷款占总工资收入比例</h2>
          </td>
        </tr>
        </tbody>
      </table>
      <div id="debt-guage" class="graphic">
        <svg style="overflow: hidden; position: relative; " height="100%" version="1.1" width="100%" xmlns="http://www.w3.org/2000/svg"><desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); ">Created with Rapha�l 2.1.0</desc><defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); "><filter id="debt-guage-inner-shadow"><feOffset dx="0" dy="3"></feOffset><feGaussianBlur result="offset-blur" stdDeviation="5"></feGaussianBlur><feComposite operator="out" in="SourceGraphic" in2="offset-blur" result="inverse"></feComposite><feFlood flood-color="black" flood-opacity="0.2" result="color"></feFlood><feComposite operator="in" in="color" in2="inverse" result="shadow"></feComposite><feComposite operator="over" in="shadow" in2="SourceGraphic"></feComposite></filter></defs><path style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); " fill="#edebeb" stroke="none" d="M50,128L20,128A80,80,0,0,1,180,128L150,128A50,50,0,0,0,50,128Z" filter="url(#debt-guage-inner-shadow)"></path><path style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); " fill="#bd3726" stroke="none" d="M50,128L20,128A80,80,0,0,1,112.5147572032185,48.984932752388985L107.82172325201155,78.61558297024311A50,50,0,0,0,50,128Z" filter="url(#debt-guage-inner-shadow)"></path><text style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: bold; font-size: 16px; line-height: normal; font-family: Arial; fill-opacity: 1; " x="100" y="24.615384615384617" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#999999" font-size="16px" font-weight="bold" font-family="Arial" fill-opacity="1"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); " dy="24.615384615384617"> </tspan></text><text style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: bold; font-size: 25px; line-height: normal; font-family: Arial; fill-opacity: 1; " x="100" y="114.28571428571429" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#bd3726" font-size="25px" font-weight="bold" font-family="Arial" fill-opacity="1"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); " dy="8.785714285714292">55%</tspan></text><text style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10px; line-height: normal; font-family: Arial; fill-opacity: 1; " x="100" y="132.78571428571428" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#b3b3b3" font-size="10px" font-weight="normal" font-family="Arial" fill-opacity="1"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); " dy="132.78571428571428"></tspan></text><text style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10px; line-height: normal; font-family: Arial; fill-opacity: 1; " x="35" y="141.99999999999997" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#b3b3b3" font-size="10px" font-weight="normal" font-family="Arial" fill-opacity="1"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); " dy="3.4999999999999716">0%</tspan></text><text style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: middle; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10px; line-height: normal; font-family: Arial; fill-opacity: 1; " x="165" y="141.99999999999997" text-anchor="middle" font="10px &quot;Arial&quot;" stroke="none" fill="#b3b3b3" font-size="10px" font-weight="normal" font-family="Arial" fill-opacity="1"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); " dy="3.4999999999999716">100%</tspan></text></svg>
      </div>
      <div class="info">月供金额不应超过您家庭月收入的<b>36%</b></div>
      <div class="separator"></div>
      <table id="debt-breakdown" class="breakdown">
        <tbody>
        <tr>
          <th colspan="3"> <h2>月收入分配</h2> </th>
        </tr>
        <tr class="graph m-value">
          <td>
            <span class="glossary">月还房贷</span>
          </td>
          <td class="value">￥2000</td>
          <td class="last-child">
            <div class="level error" style="width: 31.171030666123606px; padding: 6px 1px; "></div>
          </td>
        </tr>
        <tr class="graph m-insurance">
          <td>
            <span class="glossary">生活必要支出</span>
          </td>
          <td class="value">￥500</td>
          <td class="last-child">
            <div class="level error" style="width: 8.064043681103708px; padding: 6px 1px; "></div>
          </td>
        </tr>
        <tr class="graph real-estate-tax">
          <td>
            <span class="glossary">消费性支出</span>
          </td>
          <td class="value">￥500</td>
          <td class="last-child">
            <div class="level error" style="width: 40px; padding: 6px 1px; "></div>
          </td>
        </tr>
        <tr class="graph home-insurance">
          <td>
            <span class="glossary">投资性支出</span>
          </td>
          <td class="value">￥2000</td>
          <td class="last-child">
            <div class="level error" style="width: 9.646503865836422px; padding: 6px 1px; "></div>
          </td>
        </tr>
        <tr class="last-child">
          <td colspan="2" class="home-total" style="color: rgb(189, 55, 38); ">￥5000</td>
        </tr>
        </tbody>
      </table>
    </div>
    <p class="light" id="hmv-s2">基于上述信息，您的购房月供是<b>3000</b>元每月。加上您其他的月贷款，您一共是每月还贷<b>4500</b>元。</p>
    <p class="light">即使您可以通过其他途径借贷到更大比例金额，我们还是建议您月贷款比例小于您家庭月收入的<b>50%</b>，或者说<b>4500</b>元。</p>
  </div>
  <div class="spacer s15"></div>
  <h3 class="title">存款、首付、贷款总额</h3>
  <div class="clearfix">
    <div class="additional-content">
      <table>
        <tbody>
        <tr>
          <td>
            <div id="savings-indicator" class="ok-icon"></div>
          </td>
          <td>
            <h2>首付后家庭积蓄</h2>
          </td>
        </tr>
        </tbody>
      </table>
      <div id="closing-graphic" class="graphic" style="color: rgb(103, 169, 83); ">
        <span class="cushion-left">13 </span>
        <span class="cushion-left-text">个月家庭流动资金</span>
        <div class="indicator">
          <i class="icon-calendar cushion one two three four" style="display: inline; "></i>
          <i class="icon-calendar cushion two three four" style="display: inline; "></i>
          <i class="icon-calendar cushion three four" style="display: inline; "></i>
          <i class="icon-plus cushion four" style="display: inline; "></i>
        </div>
      </div>
    </div>
    <p class="light">要购买<b>100</b>万的房子，基于以上假设，首付总金额将为<b>330000</b>元。这意味着您的首付房产费用将是<b>70%</b>。</p>
    <p class="light">付清首付款后，您仍然将拥有<b>200000</b>元的储蓄，足够支付3个月月供金额，我们认为您至少应该拥有3个月的月供金额在手头上。</p>
  </div>
</div>
</div>
</div>
</div>

<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3>高级设置</h3>
  </div>
  <div class="modal-body">
    <table width="100%" class="adv-s" border="0">
      <tbody>
      <tr>
        <td colspan="6" class="h">首付房款信息</td>
      </tr>
      <tr>
        <td class="n">卖一套房</td>
        <td>
          <div class="control-group">
            <div class="input-prepend">
              <span class="add-on">￥</span>
              <input id="sell_house_account" size="16" type="text">
            </div>
          </div>
        </td>
        <td class="n">家庭储蓄</td>
        <td>
          <div class="control-group">
            <div class="input-prepend">
              <span class="add-on">￥</span>
              <input id="family_saving_account" size="16" type="text">
            </div>
          </div>
        </td>
        <td class="n">亲朋借钱</td>
        <td>
          <div class="control-group">
            <div class="input-prepend">
              <span class="add-on">￥</span>
              <input id="borrowing_account" size="16" type="text">
            </div>
          </div>
        </td>
      </tr>
      <tr><td colspan="6" class="spacer"></td></tr>
      <tr> <td colspan="6" class="border"></td> </tr>
      <tr>
        <td class="n">个人住房公积金月缴纳</td>
        <td>
          <div class="control-group">
            <div class="input-prepend">
              <span class="add-on">￥</span>
              <input id="monthly_public_fund_house" size="16" type="text">
            </div>
          </div>
        </td>
        <td class="n">配偶住房公积金月缴纳</td>
        <td>
          <div class="control-group">
            <div class="input-prepend">
              <span class="add-on">￥</span>
              <input id="spouse_monthly_public_fund_house" size="16" type="text">
            </div>
          </div>
        </td>
        <td class="n">商业贷款年数</td>
        <td>
          <input id="loan_commercial_years" size="16" type="text">
        </td>
      </tr>
      <tr> <td colspan="6" class="spacer"></td> </tr>
      <tr> <td colspan="6" class="border"></td> </tr>
      <tr>
        <td class="n">商业贷款利率</td>
        <td>
          <div class="control-group">
            <div class="input-append">
              <input id="loan_commercial_rate" size="16" type="text">
              <span class="add-on">%</span>
            </div>
          </div>
        </td>
        <td class="n">城市</td>
        <td>
          <input id="city" size="16" type="text">
        </td>
        <td class="n"></td>
        <td></td>
      </tr>
      </tbody>
    </table>
  </div>
  <div class="modal-footer">
    <button class="btn btn-success" id="save">保存</button>
    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
  </div>
</div>

<script>

    var calculate = {
        '+' : function(arg1,arg2){
            var r1,r2,m;
            try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}
            try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}
            m=Math.pow(10,Math.max(r1,r2));
            return (arg1*m+arg2*m)/m;
        },
        '-' : function(arg1,arg2){
            var r1,r2,m,n;
            try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}
            try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}
            m=Math.pow(10,Math.max(r1,r2));
            n=(r1>=r2)?r1:r2;
            return ((arg1*m-arg2*m)/m).toFixed(n);
        },
        '*' : function(arg1,arg2){
            var m=0,s1=arg1.toString(),s2=arg2.toString();
            try{m+=s1.split(".")[1].length}catch(e){}
            try{m+=s2.split(".")[1].length}catch(e){}
            return Number(s1.replace(".",""))*Number(s2.replace(".",""))/Math.pow(10,m);
        },
        '/' : function(arg1,arg2){
            var t1=0,t2=0,r1,r2;
            try{t1=arg1.toString().split(".")[1].length}catch(e){}
            try{t2=arg2.toString().split(".")[1].length}catch(e){}
            r1=Number(arg1.toString().replace(".",""))
            r2=Number(arg2.toString().replace(".",""))
            return (r1/r2)*Math.pow(10,t2-t1);
        }
    };

    $(document).ready(function(){
        <% if @userhousetarget!=nil %>
        $("#sell_house_account").attr("value","<%=@userhousetarget.sell_house_account  %>")
        $("#family_saving_account").attr("value","<%=@userhousetarget.family_saving_account  %>")
        $("#borrowing_account").attr("value","<%=@userhousetarget.borrowing_account  %>")
        $("#monthly_public_fund_house").attr("value","<%=@userhousetarget.monthly_public_fund_house  %>")
        $(".monthly_public_fund_house").html("￥<%=@userhousetarget.monthly_public_fund_house  %>")
        $("#spouse_monthly_public_fund_house").attr("value","<%=@userhousetarget.spouse_monthly_public_fund_house  %>")
        $(".spouse_monthly_public_fund_house").html("￥<%=@userhousetarget.spouse_monthly_public_fund_house  %>")
        $("#loan_commercial_years").attr("value","<%=@userhousetarget.loan_commercial_years  %>")
        $("#loan_commercial_rate").attr("value","<%=@userhousetarget.loan_commercial_rate  %>")
        $("#city").attr("value","<%=@userhousetarget.city  %>")
        $("#buy_house_type").attr("value","<%=@userhousetarget.buy_house_type  %>")
        $("#buy_house_area").attr("value","<%=@userhousetarget.buy_house_area  %>")
        $("#buy_house_uint_prince").attr("value","<%= (@downpayment/0.3/@userhousetarget.buy_house_area).to_i  %>")
        $("#buy_house_attribute").attr("value","<%=@userhousetarget.buy_house_attribute  %>")
        $("#house_sell_years").attr("value","<%=@userhousetarget.house_sell_years  %>")
        $("#is_first_house").attr("value","<%=@userhousetarget.is_first_house  %>")
        <% end %>
        housetype();
        submit();
    });

    $("#save").click(function(){
        $.post("/usertargets/house_target_save",{ username:"<%= session[:webusername] %>",sell_house_account: $("#sell_house_account").attr("value"),city: $("#city").attr("value"),
            family_saving_account: $("#family_saving_account").attr("value"),borrowing_account: $("#borrowing_account").attr("value"),monthly_public_fund_house: $("#monthly_public_fund_house").attr("value"),
            spouse_monthly_public_fund_house: $("#spouse_monthly_public_fund_house").attr("value"),loan_commercial_years: $("#loan_commercial_years").attr("value"),loan_commercial_rate: $("#loan_commercial_rate").attr("value")
        },function(data){
            location.reload();
        });
    });

    $("#savehouse").click(function(){
        $.post("/usertargets/housebuyingtarget_save",{ username:"<%= session[:webusername] %>",buy_house_type: $("#buy_house_type").attr("value"),buy_house_area: $("#buy_house_area").attr("value"),
            buy_house_uint_prince: $("#buy_house_uint_prince").attr("value"),buy_house_attribute: $("#buy_house_attribute").attr("value"),house_sell_years: $("#house_sell_years").attr("value"),
            is_first_house: $("#is_first_house").attr("value")
        },function(data){
        });
        submit();
    });


    function submit(){
        var leixing =1,
                weiyi = parseInt($("#buy_house_attribute").attr("value"))+1, //1,2(0,1)
                dianti = 1,
                danjia = $("#buy_house_uint_prince").attr("value") != ''?parseInt($("#buy_house_uint_prince").attr("value")) :0,
                mianji = $("#buy_house_area").attr("value") != ''?parseInt($("#buy_house_area").attr("value")) :0;

        var gongshi = {
            '1+1' : 120,
            '1+2' : 75,
            '2+1' : 90,
            '2+2' : 50
        };

        var qiesui = {
            '90+1' : 0.01,
            '144+1' : 0.015,
            '144-2' : 0.03
        };
        var total = calculate['*'](danjia, mianji);
        var jijin=calculate['*'](gongshi[parseInt(leixing) + '+' + parseInt(dianti)], mianji);

        var type = '';
        if(mianji <= 90 && weiyi == 1){
            type = '90+1';
        }else if(mianji > 90 && mianji <= 144 && weiyi == 1){
            type = '144+1';
        }else if(mianji > 144 || weiyi == 2){
            type = '144-2';
        }
        var qisui=calculate['*'](qiesui[type], total);

        $("#display-jijin").html("￥"+jijin.toString())
        $("#display-qishui").html("￥"+qisui.toString())
        $("#display-ctotal").html("￥"+(parseInt(<%= @downpayment %>)+jijin+qisui).toString())
    }

    $("#rate-decrease").click(function(){
        if(parseInt($("#downpaymentrate").attr("value"))>1){
            $("#downpaymentrate").attr("value", parseInt($("#downpaymentrate").attr("value"))-1);
        }
        else{
            $("#downpaymentrate").attr("value",1);
        }
        update();
    });

    $("#rate-increase").click(function(){
        if(parseInt($("#downpaymentrate").attr("value"))<100){
            $("#downpaymentrate").attr("value", parseInt($("#downpaymentrate").attr("value"))+1);
        }
        else{
            $("#downpaymentrate").attr("value",100);
        }
        update();
    });

    function update(){
        $("#display-sub-dp").html($("#downpaymentrate").attr("value")+"%");
        $("#display-hv").attr("value","￥"+parseInt(parseInt($("#display-dp").attr("value").replace("￥",""))*100/parseInt($("#downpaymentrate").attr("value"))).toString());
    }

    function housetype(){
        if($("#buy_house_type").attr("value")=='0'){
            $("#inputs-credit").removeClass("hide");
            $(".inputs-location").addClass("hide");
        }
        else{
            $("#inputs-credit").addClass("hide");
            $(".inputs-location").removeClass("hide");
        }
    }

    function housearea(){
       if($("#buy_house_area").attr("value")!=""){
        $("#buy_house_uint_prince").attr("value", parseInt(parseInt(<%= @downpayment %>)*100/parseInt($("#downpaymentrate").attr("value"))/parseInt($("#buy_house_area").attr("value"))));
       }
    }
</script>

<script>

    var init_income = "15,000";
    var init_pincome = "0";
    var init_state = "S";
    var init_taxfiling = "tx-s";
    var min_income = parseInt("14000");

    function validateIncomeInput()
    {
        var inc = getInteger($(".primaryIncome input").val());
        var pinc = getInteger($(".partnerIncome input").val());
        var isSingle = "S" === $("#singlepartnered input:checked").val();
        var totalIncome = inc + (isSingle ? 0 : pinc);

        if (totalIncome < min_income) {
            $(".primaryIncome .input-note, .input-error-on-page").addClass("error").html("Please note, to use SmartAsset you must enter an income of more than $" + commatoze(min_income));
            $(".input-error-on-page").css('visibility', 'visible');
            $(".primaryIncome .input-block, .partnerIncome .input-block").addClass("error");
            $(".primaryIncome input").focus();

            return false;
        }

        return true;
    }

    function submitIncome()
    {
        if (!validateIncomeInput()) {
            return;
        }

        var inc = $(".primaryIncome input").val();
        var pinc = $(".partnerIncome input").val();
        var tfs = "tx-mfj";
        var pstatus = $("#singlepartnered input:checked").val();

        if (pstatus == "S")
        {
            pinc = "0";
            tfs = "tx-s";
        }

        var callback = function(data)
        {
            if (data)
            {
                if (data.status == "ok")
                {
                    hideLoadingButton($(".input-buttons button.btn-next"));
                    $("#body-inputs .input-buttons button.btn-back").show();
                    closeOverlayOnly();

                    // trigger hook
                    smartasset.data.set("inputs-total-income", getInteger(inc)+getInteger(pinc));
                    ajaxUpdate("", "mode=animate");
                }
                else
                {
                    showModal("An error occurred", null, data.message);
                }
            }
        };

        inputSubmit({
            input: "income", // remains for legacy analytics purposes
            state: "income",
            income: getInteger($(".primaryIncome input").val()),
            pincome: getInteger($(".partnerIncome input").val()),
            taxfs: tfs,
            pstatus: pstatus,
            tfs:tfs
        }, callback);
    }

    $(function() {
        /// track partner group
        $("#singlepartnered input").click(function() {
            var v = $("#singlepartnered input:checked").val();
            //track event
            eventTrack("Select Option Change", {select:"singlepartnered", value: v}, "["+v+"] "+"singlepartnered");

            if (v == "P")
            {
                $(".partnerIncome").css("display", "inline-block");
            }
            else
            {
                $(".partnerIncome").css("display", "none");
            }

            incomeAddUp();
        });

        var clearError = function() {
            $(".income-totals").show();
            $(".income-error").hide();
            $(".input-error-on-page").css('visibility', 'hidden');
            $(".primaryIncome .input-block, .partnerIncome .input-block").removeClass("error");
        }

        $(".primaryIncome input").keyup(function(e) {
            incomeAddUp();
            if (e.keyCode !== 13) {
                clearError();
            }
        });

        $(".partnerIncome input").keyup(function(e) {
            incomeAddUp();
            if (e.keyCode !== 13) {
                clearError();
            }
        });

        setTimeout('$(".primaryIncome input").focus()', 100);
    });

    function incomeAddUp()
    {
        var i = getInteger($(".primaryIncome input").val());
        if ($("#singlepartnered input:checked").val() == "P")
        {
            i += getInteger($(".partnerIncome input").val());
        }

        $("span#display-income-total").html("$"+commatoze(i));
    }

    function incomeBeforeShow()
    {
        $(".primaryIncome input").val(init_income);
        $(".partnerIncome input").val(init_pincome);

        // reset
        $(".primaryIncome .input-block, .partnerIncome .input-block").removeClass("error");
        $(".primaryIncome .input-note").removeClass("error").html("What is your total 'pre-tax' income per year?");


        if (init_state == "P")
        {
            $(".partnerIncome").css("display", "inline-block");
            $("#singlepartnered input.p-partnered").attr("checked", "checked");
        }
        else
        {
            $(".partnerIncome").css("display", "none");
            $("#singlepartnered input.p-single").attr("checked", "checked");
        }

        $("#"+init_taxfiling).attr('selected', true);

        hideLoadingButton($("#overlay-inputs-income .input-buttons button.btn"));

        incomeAddUp();
    }

    function incomeAfterShow()
    {
        $(".primaryIncome input").focus();
    }
</script>