<%= stylesheet_link_tag "p1_usersurvey.css" %>
<%= javascript_include_tag "bootstrap.min.js" %>

<div class="welcomes start p1s4">
  <%= render "side" %>
  <div id="page-content">
    <h1>资产净值表<span class="red">（资产）</span>
      <div id="q-numbers"><b class="q-num past">1</b><b class="q-num past">2</b><b class="q-num past">3</b><b class="q-num curr">4</b><b class="q-num">5</b></div>
    </h1>
    <div class="tablet">
      <div class="row-fluid">
        <div class="span1">
          <span>4</span>
        </div>
        <div class="span11">
          <div class="mleft">
            <p class="q-text">总结至今为止您已积攒的资产，这个简明的资产表仅仅是您在某个时期的阶段性总结，实际上资产净值每天都根据资产价值张张落落，但这个资产表可以在很长时间里帮助你及时发现财务危机，计划理财方式，并确保您直达目标。<br>
            切记，填写的应该是资产的当期市值，而不是购买价格。</p>
            <div class="row-fluid op-label">
              <div class="span3 q-text">资产品种</div>
              <div class="span3 q-text" style="text-align: left;">产品简介</div>
              <div class="span2 q-text" style="text-align: left;">资产金额</div>
              <div class="span1"></div>
            </div>
            <div class="seperator thick"></div>
            <div class="founder-inputs">
              <div class="op-input first" fid="founder">
                <div class="seperator bottom"></div>
                <div class="row-fluid">
                  <div class="span3 control-group">
                    <select name="variety" id="variety" class="founder-name" title="资产品种"  onchange="updateintro(this)">
                      <% @assettype.each do |a| %>
                          <option value="<%= a.asset_typeid %>"><%= a.asset_typename %></option>
                      <% end %>
                    </select>
                  </div>
                  <div class="span3 control-group" style="text-align: left;">
                    <blockquote><small class="pname" id="pname"><%= @assettype[0].asset_intro %></small></blockquote>
                  </div>
                  <div class="span2" style="text-align: center;">
                    <div class="input-prepend">
                      <span class="add-on">￥</span>
                      <input class="init-share" name="lnw" id="amount" style="width: 180px;" onMouseOver="if(this.value==0){this.value='';}"value="0" type="text">
                    </div>
                  </div>
                  <div class="span1 top5" style="margin-top: 10px;margin-left: 40px;height: 20px;overflow: hidden;"><i class="icon-remove-sign" style="display: none;margin-left: 20px;font-size: 30px;" onclick="removeFounder(this);">&nbsp;&nbsp;</i></div>
                </div>
              </div>
            </div>
            <div class="seperator bottom thick"></div>
            <a data-original-title="Click here to add another company founder" class="xtip pull-right"style="padding: 0 20px 10px 0;" onclick="addFounder(null, false);"> + 添加资产 </a>
          </div>
        </div>
      </div>
    </div>
    <div id="q-buttons" class="">
      <button class="q-button light-gray big-button" id="q-back">◄&nbsp; <span>上一题</span>&nbsp;</button>
      <button class="q-button orange-button big-button" id="q-next">&nbsp;下一题 &nbsp;►</button>
    </div>
  </div>
</div>

<script>
    var eCalcShareHolders = new Object();
    var debug = false;

    function addFounder(founder, isFirst)
    {
        var aaa = genId(eCalcShareHolders);
        var f = founder;
        if(f == null) // create a new share holder
        {
            f = new ShareHolder();
            f.setupShareHolder(true, false, false);
            f.id= "founder-" + aaa;
            f.name = "Founder " + getNewNameNumber(eCalcShareHolders, "founder");
            eCalcShareHolders[f.id] = f;
        }

        if(!isFirst)
        {
            var fi = $("div.founder-inputs div.op-input").last().clone().removeClass("first");
            $(fi).find(".icon-remove-sign").show();
            var fid = f.id;
            $(fi).attr("fid", fid);
            // put values in
            $(fi).find(".founder-name").attr("id",'variety'+aaa);
            $(fi).find(".init-share").val(0);
            $(fi).find(".init-share").attr("id",'amount'+aaa);
            $(fi).find(".pname").attr("id",'pname'+aaa);
            $("div.founder-inputs").append(fi);
        }
    }

    function genId(map)
    {
        //cslog("Generating id for object.");
        var tId = 0;
        for(var id in map)
        {
            var count = id.split("-")[1];
            if(getInteger(count) > tId)
            {
                tId = count;
            }
        }
        return getInteger(tId) + 1;
    }

    function getInteger(v)
    {
        if (v != null && typeof(v) == 'string' & v != "")
        {
            v = v.replace(/\$/, "");
            v = v.replace(/,/g, "");
            v = v.replace(/\..*/g, "");
            var r = parseInt(v, 10);
            if (!isNaN(r))
                return r;
        }
        if (typeof(v) == "number")
        {
            return parseInt(v, 10);
        }

        return 0;
    }

    var ShareHolder = function()
    {
        this.isFounder = true;
        this.isEmployee = false;
        this.isSeries = false;
        this.percentStake = 0;
        this.totalShares = 0;
        this.name = "name";
        this.id = null;

        this.setupShareHolder = function(isFounder, isEmployee, isSeries)
        {
            if(isFounder)
            {
                this.isFounder = true;
                this.isEmployee = false;
                this.isSeries = false;
            }
            else if(isEmployee)
            {
                this.isFounder = false;
                this.isEmployee = true;
                this.isSeries = false;
            }
            else if(isSeries)
            {
                this.isFounder = false;
                this.isEmployee = false;
                this.isSeries = true;
            }
        }

        // Use to create a JSON object from the Founder
        this.renderJson = function()
        {
            return {
                isFounder: this.isFounder, isEmployee: this.isEmployee,
                isSeries: this.isSeries, percentStake: this.percentStake,
                totalShares: this.totalShares, id: this.id, name:this.name
            };
        }
    }

    function getNewNameNumber(shareHolders, type)
    {
        var fRegex = /founder\s\d/i;
        if(type == "employee")
        {
            fRegex = /employee\s\d/i;
        }
        var latestId = 1;
        for(var id in shareHolders)
        {
            if(type != "employee" && shareHolders[id].isFounder && fRegex.test(shareHolders[id].name))
            {
                var curNum = getInteger(fRegex.exec(shareHolders[id].name)[0].split(" ")[1]);
                if(curNum >= latestId)
                {
                    latestId  = curNum + 1;
                }
            }
            else if(type == "employee" && shareHolders[id].isEmployee && fRegex.test(shareHolders[id].name))
            {
                var curNum = getInteger(fRegex.exec(shareHolders[id].name)[0].split(" ")[1]);
                if(curNum >= latestId)
                {
                    latestId  = curNum + 1;
                }
            }
        }
        return latestId;
    }

    function removeFounder(e)
    {
        var fi = $(e).closest("div.op-input");
        var fid = $(fi).attr("fid");
        delete eCalcShareHolders[fid];
        $(fi).detach();
    }
</script>

<script>
    function updateintro(e){
        var pid=e.id.replace('variety','pname')
    <% @assettype.each do |a| %>
        if('<%= a.asset_typeid %>'== e.value){
            $("#"+pid).html('<%= a.asset_intro %>')
        }
    <% end %>
    }

    $(document).ready(function(){
        <% if session[:webusername]!=nil %>
        var first=0;
        <% if @userassetsheet!=nil && @userassetsheet.size!=0 %>
        <% for i in 0..@userassetsheet.size-1 %>
        if(first==0){
            $("#variety").attr("value",'<%= @userassetsheet[i].asset_typeid %>')
            $("#amount").attr("value",'<%= @userassetsheet[i].asset_value %>')
        <% @assettype.each do |a| %>
            if('<%= a.asset_typeid %>'=='<%= @userassetsheet[i].asset_typeid %>'){
                $("#pname").html('<%= a.asset_intro %>')
            }
        <% end %>
        }
        else{
            addFounder(null, false);
            $("#variety"+first).attr("value",'<%= @userassetsheet[i].asset_typeid %>')
            $("#amount"+first).attr("value",'<%= @userassetsheet[i].asset_value %>');
        <% @assettype.each do |a| %>
            if('<%= a.asset_typeid %>'=='<%= @userassetsheet[i].asset_typeid %>'){
                $("#pname"+first).html('<%= a.asset_intro %>')
            }
        <% end %>
        }
        first=first+1;
        <% end %>
        <% end %>
        <% end %>
    });

    $("#q-numbers").delegate(".q-num.past", "click", function() {
        if($(this).html()=='1'){
            save("/usersurvey/p1s1_user_basic_info");
        }
        if($(this).html()=='2'){
            save("/usersurvey/p1s2_cash_flow_statement_month");
        }
        if($(this).html()=='3'){
            save("/usersurvey/p1s3_cash_flow_statement_year");
        }
    });

    $("#q-back").click(function(){
        location.href="/usersurvey/p1s3_cash_flow_statement_year";
    });

    $("#q-next").click(function(){
        save("/usersurvey/p1s5_debt_table");
    });

    function save(e){
        var variety=document.getElementsByClassName("founder-name")  //资产品种
        var amount=document.getElementsByClassName("init-share")  //资产金额
        var typeid='',typevalue='';
        for(j=0;j<variety.length;j++){
            var ccc=amount[j].value.replace(/,/g, "");
            if(ccc==''){ccc=0;}
            if(j==0){
                typeid=variety[j].value.replace(/,/g, "");
                typevalue=amount[j].value.replace(/,/g, "");
            }
            else{
                typeid=typeid+','+variety[j].value.replace(/,/g, "");
                typevalue=typevalue+','+amount[j].value.replace(/,/g, "");
            }
        }

        $.post("/usersurvey/p1s4_asset_table_save",{username:'<%= session[:webusername] %>',asset_typeid:typeid,asset_value:typevalue},function(data){
            location.href=e;
        });
    }
</script>