<%= stylesheet_link_tag "usersurvey.css" %>
<%= javascript_include_tag "placeholder.js" %>

<div class="main-content">
  <a href="/">首页</a><br><br>
  <div id="application">
    <div class="modal-header">
      <% if session[:webusername]!=nil %>
          <h3>服务申请</h3>
      <% else %>
          <h3>服务申请 并注册</h3>
      <% end %>
    </div>
    <form>
      <div class="modal-body">
        <div id="user1" style="display: none; color: red;font-size: 12px;"><div id="user2"></div><br></div>
        <% if session[:webusername]==nil %>
            <input id="username" type="text" name="username" placeholder="用户名"><br>
            <input id="password" type="password" name="password" placeholder="登录密码"><br>
        <% end %>
        <input id="email" type="text" name="email" placeholder="电子邮箱">
        <p>如果有疑问，通天顺家庭理财可以随时和您沟通，方便理财方案制作。</p>
        <input id="tel" type="text" name="tel" placeholder="联系电话">
      </div>
      <div class="modal-footer">
        <div class="clear"><input type="submit" value="申请服务" name="subscribe" id="subscribe" class="btn btn-primary"></div>
      </div>
    </form>
  </div>
</div>

<script>
    var flag = true;
    $("#subscribe").click(function(){
        var myreg = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}.*$/;
        var phone = /^1(3[0-9]|5[0-35-9]|8[0235-9])\d{8}$/;
        var name=/^\D.{2}.*$/;
        var log=0;

        <% if session[:webusername]==nil %>
        if($("#username").attr("value")==""){
            $('#user1').show();
            $("#user2").html("用户名为空！");
            log=1;
            return false;
        }
        else if($("#password").attr("value")==""){
            $('#user1').show();
            $("#user2").html("密码为空！");
            log=1;
            return false;
        }
        <% end %>
        if (log==0){
            if($("#email").attr("value")==""){
                $('#user1').show();
                $("#user2").html("电子邮箱为空！");
                return false;
            }
            else if(!myreg.test($("#email").attr("value"))){
                $('#user1').show();
                $("#user2").html("电子邮箱格式不正确！");
                return false;
            }
            else if($("#tel").attr("value")==""){
                $('#user1').show();
                $("#user2").html("联系电话为空！");
                return false;
            }
            else if(!phone.test($("#tel").attr("value"))){
                $('#user1').show();
                $("#user2").html("联系电话格式不正确！");
                return false;
            }
            else{
                if (flag) {
                    flag = false;
                $('#user1').hide();
                userconfig('#email','#tel');
                    setTimeout(function(){flag = true;}, 5000); // 5秒间隔
                return false;
            }
                else{
                    $('#user1').show();
                    $("#user2").html("正在处理中，请稍候！");
                    return false;
                }
            }
        }
    });

    function userconfig(eid,tid){
    <% if session[:webusername]!=nil %>
        var username='<%= session[:webusername] %>';
        var password='tongtianshun';
    <% else %>
        var username=$("#username").attr("value");
        var password=$("#password").attr("value");
    <% end %>
        $.get("/admin/applyconfigajax",{username:username,password:password,tel:$(tid).attr("value"),address: 1,postcode: 1,name:1,email:$(eid).attr("value"),company:1,division:1,organuser:0,securitiesnum:0,memberlevel:0,title:"用户申请理财师服务",risktolerance:"",asset_allocation:"",wbreedinfo:""},function(data){
            if(data=="r2"){
                $('#user1').show();
                $("#user2").html("用户名已注册！密码错误");
            }
            else if(data=="organ"){
                $('#user1').hide();
                alert("我们会尽快联系您");
                location.href='/personmanagement/organfinance';
            }
            else{
                $('#user1').hide();
                alert("我们会尽快联系您");
                location.href='/home/plan';
            }
        });
    }
    $(document).ready(function () {
        <% if session[:webusername]!=nil %>
        $("#email").val('<%= @webuser.email %>')
        $("#tel").val('<%= @webuser.tel %>')
        <% end %>
    });
</script>