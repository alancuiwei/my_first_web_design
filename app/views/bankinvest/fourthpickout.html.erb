<%= javascript_include_tag "jquery.dataTables.min.js" %>
<%= javascript_include_tag "placeholder.js" %>
<%= stylesheet_link_tag "datatables.css" %>
<%= stylesheet_link_tag "bankinvest.css" %>
<%= javascript_include_tag "bootstrap.js" %>

<div class="main-contents">
  <table>
    <tr>
      <td class="left">
        <div class="main-inputs">
          <div id="inputs" class="content2">
            <div class="padded">
              <h1>关于银行理财产品</h1>
              <p>这里的银行理财产品是由银行自行设计并发行，而不是作为销售渠道，和信托、基金、保险等金融机构合作的产品。
                <span>这种类型的产品风险极低。</span></p>
            </div>
            <div id="myTabContent" class="tab-content">
              <div class="overlays tab-pane fade in active" id="fourth">
                <div class="input-group active">
                  <p class="group">投入资金</p>
                  <div class="input-prepend input-append">
                    <span class="add-on"><div class="indicator-icon custom small"></div></span>
                    <input class="input-small" type="text" name="amount" href="#first" data-toggle="tab" id="amount" value="">
                    <span class="add-on neutral"><div class="edit-pencil"></div></span>
                  </div>
                </div>
                <div class="input-group active">
                  <p class="group">投资期限</p>
                  <div class="input-prepend input-append">
                    <span class="add-on"><div class="indicator-icon custom small"></div></span>
                    <input class="input-small" type="text" name="deadline" href="#second" data-toggle="tab" id="deadline" value="">
                    <span class="add-on neutral"><div class="edit-pencil"></div></span>
                  </div>
                </div>
                <div class="input-group active">
                  <p class="group">风险性</p>
                  <div class="input-prepend input-append">
                    <span class="add-on"><div class="indicator-icon custom small"></div></span>
                    <input class="input-small" type="text" name="risk" href="#third" data-toggle="tab" id="risk" value="">
                    <span class="add-on neutral"><div class="edit-pencil"></div></span>
                  </div>
                </div>
              </div>
              <div class="overlay tab-pane fade" id="first">
                <form name="form1" action="" method="post" onsubmit="return checkinput1()">
                  <h1>1. 资金</h1>
                  <p class="group">资金投入</p>
                  <div class="input-append">
                    <input class="input-medium" name="amounts" id="amounts" type="text" placeholder="请输入投资金额">
                    <span class="add-on">元</span>
                  </div>
                  <p>最低投入资金为50000元。</p>
                  <a class="btn btn-primary pull-right" href="#fourth"  data-toggle="tab" id ="checkinput1"  type="submit">确定</a>
                </form>
              </div>
              <div class="overlay tab-pane fade" id="second">
                <h1>2. 投资周期</h1>
                <form name="form2" action="" method="post" onsubmit="return checkinput2()">
                  <p class="group">我个人倾向于</p>
                  <select  name="deadlines" id="deadlines">
                    <option value="365">中期投资 (3个月-1年)</option>
                    <option value="90">短期投资 (3个月)</option>
                    <option value="366">长期投资 (1年以上)</option>
                  </select>
                  <a class="btn btn-primary pull-right" href="#fourth" data-toggle="tab" id ="checkinput2" type="submit">确定</a>
                </form>
              </div>
              <div class="overlay tab-pane fade" id="third">
                <h1>3. 风险性</h1>
                <form name="form3" action="" method="post" onsubmit="return checkinput3()">
                  <div class="controls">
                    <label class="radio"><input id="fdeficit" name="optionsRadios"  value="本金绝对不能亏损" type="radio">本金绝对不能亏损</label>
                    <br>
                    <label class="radio"><input id="cdeficit" name="optionsRadios" value="收益率不能低于通货膨胀率" type="radio">收益率不能低于通货膨胀率</label><br>
                    <div id="deficit" style="margin:0 0 0 20px;display: none;">
                      <p style="margin-bottom: 10px;">您期待的年收益率是？<br></p>
                      <div class="input-append">
                        <input class="input-medium" style="width: 118px;" name="returnrate" id="returnrate" type="text" placeholder="年收益率">
                        <span class="add-on">%</span>
                      </div>
                    </div>
                    <a class="btn btn-primary pull-right" href="#fourth" data-toggle="tab" id ="checkinput3" type="submit">确定</a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </td>
      <td>
        <div class="main-body pickout">
          <a href="/">首页</a>
          <h1>欢迎</h1>
          <table>
            <tr>
              <td class="left2 sides">
                <div class="lf-box">
                  <p>我们将根据您输入的实际情况来分析觉得如下几种银行理财产品可能会适合您。<br>
                    请您再做仔细筛选：</p>
                </div>

                <table class="table table-striped table-bordered" cellpadding="0" cellspacing="0" border="0" class="display" name="bankfinance" id="bankfinance"  style="text-align:center;">
                  <thead><tr>
                    <th class="hide">发行银行</th><th class="name">产品名称</th><th>投资期限</th>
                    <th class="hide">起售价</th><th>年化收益率</th><th>计算收益金额</th>
                    <th class="hide">是否开放</th><th>产品类型</th><th class="hide">操作</th>
                  </tr></thead>

                  <% @bankfinances.each do |b| %>
                      <tr>
                        <td class="hide"><%= b.trustee%></td>
                        <td class="name"><a href="/bankinvest/details?bid=<%= b.id%>"><%= b.bname%></a></td>
                        <% if b.investperiod != nil %>
                        <td><%= format("%0.0f",b.investperiod)%>天</td>
                        <% else %>
                            <td>0</td>
                        <% end %>
                        <% if b.startvalue != nil %>
                          <td class="hide"><%= format("%0.0f",b.startvalue/10000)%>万</td>
                        <% else %>
                          <td class="hide">0</td>
                        <% end %>
                        <% if b.returnrate != nil %>
                        <td><%= format("%0.1f",b.returnrate*100)%>%</td>
                        <% else %>
                            <td>0</td>
                        <% end %>
                        <% if b.returnrate != nil && b.investperiod != nil %>
                        <td><p title="<%= params[:amount]%>*<%= b.returnrate%>*<%= b.investperiod%>/365"><%= format("%0.2f",params[:amount].to_i*b.returnrate*b.investperiod/365) %>元</p></td>
                        <% else %>
                            <td>0</td>
                        <% end %>
                        <td class="hide"><%= b.ispatent %></td>
                        <% if b.btype=="0" || b.btype==nil || b.btype=="不保本" %>
                            <td>浮动收益</td>
                        <% else %>
                            <td>保本</td>
                        <% end %>
                        <td class="hide"><a href="/sales/index?bid=<%= b.id%>">预约</a></td>
                      </tr>
                  <% end %>
                </table>
              </td>
              <td class="right2">
                <div class="plan-column right">
                  <div style="position:relative;width: 180px;">
                    <div id="position-saver">
                      <div class="open-account-container">
                        <p class="open-account-intro">国家金融理财师(AFP)<br>量身定制方案</p> <br><br>
                        <a id="apply" class="apply" href="#login-box">申请服务</a> <br><br>
                      </div>
                      <hr>
                      <div class="faq-container">
                        <p>常见疑问</p>
                        <ul class="common-q">
                          <li><a href="/home/apply">AFP能给我提供怎样的私人服务？</a></li>
                          <li><a href="/home/afpintroduce">什么是金融理财师AFP？</a></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </table>
          <br><br>
        </div>
      </td>
    </tr>
  </table>
</div>

<div id='login-box' class='login-popup modal' style="display: none;">
  <div class="modal">
      <div class="modal-header">
        <a class="close" href="javascript:">×</a>
        <h3>服务申请</h3>
      </div>
        <div class="modal-body">
          <div id="user1" style="display: none; color: red;font-size: 12px;"><div id="user2"></div><br></div>
          <% if session[:webusername]==nil %>
              <input id="username" type="text" name="username" placeholder="用户名"><br>
              <input id="password" type="password" name="password" placeholder="登录密码">
          <% end %>
          <p>我们将把您的理财规划书发送到如下邮箱中。</p>
          <input id="email" type="text" name="email" placeholder="电子邮箱">
          <p>如果有疑问，金融理财师可以随时和您沟通，方便理财方案制作。</p>
          <input id="tel" type="text" name="tel" placeholder="联系电话">
        </div>
        <div class="modal-footer">
          <div class="clear"><input type="submit" value="申请服务" name="subscribe" id="subscribe" class="btn btn-primary"></div>
        </div>
  </div>
</div>

<script>

    $("#subscribe").click(function(){
        var myreg = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}.*$/;
        var phone = /^1(3[0-9]|5[0-35-9]|8[0235-9])\d{8}$/;
        var name=/^\D.{2}.*$/;
        var log=0;
        <% if session[:webusername]==nil %>
        if($("#username").attr("value")==""){
            $('#user1').show();
            $("#user2").html("用户名为空！");
            log=1;
            return false;
        }
        else if($("#password").attr("value")==""){
            $('#user1').show();
            $("#user2").html("密码为空！");
            log=1;
            return false;
        }
        <% end %>
        if (log==0){
            if($("#email").attr("value")==""){
                $('#user1').show();
                $("#user2").html("电子邮箱为空！");
                return false;
            }
            else if(!myreg.test($("#email").attr("value"))){
                $('#user1').show();
                $("#user2").html("电子邮箱格式不正确！");
                return false;
            }
            else if($("#tel").attr("value")==""){
                $('#user1').show();
                $("#user2").html("联系电话为空！");
                return false;
            }
            else if(!phone.test($("#tel").attr("value"))){
                $('#user1').show();
                $("#user2").html("联系电话格式不正确！");
                return false;
            }
            else{
                $('#user1').hide();
                userconfig('#email','#tel');
                return false;
            }
        }
    });

    function userconfig(eid,tid){
    <% if session[:webusername]!=nil %>
        var username='<%= session[:webusername] %>';
        var password='tongtianshun';
    <% else %>
        var username=$("#username").attr("value");
        var password=$("#password").attr("value");
    <% end %>
        $.get("/bankinvest/userconfigajax/0",{username:username,password:password,tel:$(tid).attr("value"),address: 1,postcode: 1,name:1,email:$(eid).attr("value"),company:1,division:1,organuser:0,securitiesnum:0,memberlevel:0,title:"用户申请理财师服务"},function(data){
            if(data=="r2"){
                $('#user1').show();
                $("#user2").html("用户名已注册！密码错误");
            }
            else{
                alert("我们会尽快联系您");
                location.reload();
            }
        });
    }

    $('a.apply').click(function() {
        $("#login-box").show();
        <% if params[:username]==session[:webusername] || params[:username]==nil %>
        var loginBox = $(this).attr('href');
        //Fade in the Popup and add close button
        //Set the center alignment padding + border
        var popMargTop = ($(loginBox).height() + 24) / 2;
        var popMargLeft = ($(loginBox).width() + 24) / 2;

        $(loginBox).css({
            'margin-top' : -popMargTop,
            'margin-left' : -popMargLeft
        });

        // Add the mask to body
        $('body').append('<div id="mask"></div>');
        $('#mask').fadeIn(300);

        return false;
        <% end %>
    });

    // When clicking on the button close or the mask layer the popup closed
    $('a.close, #mask').live('click', function() {
        $('#mask , .login-popup').fadeOut(300 , function() {
            $('#mask').remove();
        });
        return false;
    });

    $.fn.dataTableExt.afnFiltering.push(
            function( oSettings, aData, iDataIndex ) {
               return true;
            }
    );

    $(document).ready(function(){
        /* Initialise datatables */
        var oTable = $('#bankfinance').dataTable({
            "iDisplayLength": 10,
            "oLanguage": {
                "sZeroRecords": "很抱歉，没有符合您要求的银行理财产品，请重新设定筛选条件"
            }
        });

        $("#first,#second,#third").click( function() { oTable.fnDraw(); } );

        $("#amount").val(Request("amount")+"元");
        $("#amounts").val(Request("amount"));
        if(Request("deadline")=="90"){
          $("#deadline").val("短期投资 (3个月)");
          $("#deadlines").val("90");
        }
        else if(Request("deadline")=="365"){
            $("#deadline").val("中期投资 (3个月-1年)");
            $("#deadlines").val("365");
        }
        else if(Request("deadline")=="366"){
            $("#deadline").val("长期投资 (1年以上)");
            $("#deadlines").val("366");
        }
        if(Request("deficit")=="0"){
            var city = document.getElementsByName("optionsRadios");
                for(i=0; i<city.length; i++){
                    if(city[i].value=="本金绝对不能亏损"){
                        city[i].checked = "checked";
                    }
                    else{
                        city[i].checked = "";
                    }
                }
            $("#risk").val("本金绝对不能亏损");
            $("#deficit").hide();
        }
        else{
            var city = document.getElementsByName("optionsRadios");
            for(i=0; i<city.length; i++){
                if(city[i].value=="收益率不能低于通货膨胀率"){
                    city[i].checked = "checked";
                }
                else{
                    city[i].checked = "";
                }
            }
            $("#risk").val("收益率不能低于通货膨胀率");
            $("#deficit").show();
            $("#returnrate").val(Request("returnrate"));
        }
    });

    $("#fdeficit").click(function(e){
        $("#deficit").hide();
    });
    $("#cdeficit").click(function(e){
        $("#deficit").show();
    });

    try{
        $(function() {
            var $amt = $("#returnrate")
                    .on("update", function () {
                        var amt = this.value;
                        if (amt.match(/^\d+$/) && (amt = +amt) >= 0 && (amt = +amt) <= 100) {
                            $amt.removeClass("invalid");
                            if (amt !== $amt.data("val")) {
                                $amt.data("val", amt);
                            }
                        } else {
                            $amt.addClass("invalid");
                        }
                    })
                    .bind("keypress keyup", function() {
                        $(this).trigger("update");
                    })
        });
    } catch(e) {w.trackJsError(e); throw e;}

    try{
        $(function() {
            var $amt = $("#amounts")
                    .on("update", function () {
                        var amt = this.value;
                        if (amt.match(/^\d+$/) && (amt = +amt) >= 50000) {
                            $amt.removeClass("invalid");
                            if (amt !== $amt.data("val")) {
                                $amt.data("val", amt);
                            }
                        } else {
                            $amt.addClass("invalid");
                        }
                    })
                    .bind("keypress keyup", function() {
                        $(this).trigger("update");
                    })
        });
    } catch(e) {w.trackJsError(e); throw e;}


    $("#checkinput1").click(function(e){
        var numfor=/^[-+]?[0-9]+(\.[0-9]+)?$/;
        if($("#amounts").attr("value")=="")
        {
            $("#returnrate").addClass("invalid");
            return false;
        }
        if(numfor.test($("#amounts").attr("value"))==false)
        {
            return false;
        }
        else if($("#amounts").attr("value")<50000)
        {
            return false;
        }
        else {
            if(Request("deficit")=="0"){
                location.href="/bankinvest/fourthpickout?amount="+$("#amounts").attr("value")+"&deadline="+Request("deadline")+"&deficit=0";
            }
            else{
                location.href="/bankinvest/fourthpickout?amount="+$("#amounts").attr("value")+"&deadline="+Request("deadline")+"&deficit=1&returnrate="+Request("returnrate");
            }
        }
    });

    $("#checkinput2").click(function(e){
        if(Request("deficit")=="0"){
            location.href="/bankinvest/fourthpickout?amount="+Request("amount")+"&deadline="+$("#deadlines").attr("value")+"&deficit=0";
        }
        else{
            location.href="/bankinvest/fourthpickout?amount="+Request("amount")+"&deadline="+$("#deadlines").attr("value")+"&deficit=1&returnrate="+Request("returnrate");
        }
    });

    $("#checkinput3").click(function(e){
        var numfor=/^[-+]?[0-9]+(\.[0-9]+)?$/;
        var Obj = document.getElementsByName("optionsRadios");
        for(i=0;i<Obj.length;i++){
            if(Obj[i].checked){
                if(i==1){
                    if($("#returnrate").attr("value")==""){
                        $("#returnrate").addClass("invalid");
                        return false;
                    }
                    else if(!numfor.test($("#returnrate").attr("value"))){
                        return false;
                    }
                    else if(parseFloat($("#returnrate").attr("value"))<0 || parseFloat($("#returnrate").attr("value"))>100){
                        return false;
                    }
                }
                break;
            }
        };
        if(i==0){
            location.href="/bankinvest/fourthpickout?amount="+Request("amount")+"&deadline="+Request("deadline")+"&deficit=0";
        }
        else if(i==1){
            location.href="/bankinvest/fourthpickout?amount="+Request("amount")+"&deadline="+Request("deadline")+"&deficit=1&returnrate="+$("#returnrate").attr("value");
        }
    });

    function Request(sName)
    {
        var sURL = new String(window.location);
        var sURL = document.location.href;
        sURL=decodeURI(sURL);
        var iQMark= sURL.lastIndexOf('?');
        var iLensName=sName.length;
        //retrieve loc. of sName
        var iStart = sURL.indexOf('?' + sName +'=') //limitation 1
        if (iStart==-1)
        {//not found at start
            iStart = sURL.indexOf('&' + sName +'=')//limitation 1
            if (iStart==-1)
            {//not found at end
                return 0; //not found
            }
        }

        iStart = iStart + + iLensName + 2;
        var iTemp= sURL.indexOf('&',iStart); //next pair start
        if (iTemp ==-1)
        {//EOF
            iTemp=sURL.length;
        }
        return sURL.slice(iStart,iTemp ) ;
        sURL=null;//destroy String
    }
</script>