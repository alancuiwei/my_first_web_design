<%= stylesheet_link_tag "bankinvest.css" %>
<%= javascript_include_tag "highcharts.js" %>

<% if @banfinance.isorgan!=true && (@banfinance.productstate=='yhlc' || @banfinance.productstate=='qslc') %>
<style>
    .details td.right{
        width: 26%;
        white-space:pre-line;
        line-height: 20px;
        font-size: 12px;
        text-align: center;
        background-color: #ffffff!important;
    }
    .details td.left{
        width:24%;
        vertical-align: middle;
        color: #000000;
        background-color: #fbfbfb;
        font-weight: normal;
        font-size: 14px;
        text-align: left;
        padding-left: 10px;
    }
</style>
<% end %>
<% if @banfinance.isorgan!=true && @banfinance.productstate!='yhlc' %>
    <style>
        .box_left_title1{
            margin-bottom: 10px;
        }
    </style>
<% end %>

<div class="main-content details">
<% if @banfinance.isorgan==true %>
    <div style="width: 80%;">
<% else %>
    <div style="width: 60%;min-width: 692px;">
<% end %>
        <a href="/">首页</a>
    <br><br>

<div class="box_left_title1">
  <%= @banfinance.bname%><span class="pull-right"><a class="btn btn-primary pull-left" href="javascript:void(0)" id="reserve">预约</a></span>
</div>
<% if @banfinance.isorgan!=true && @banfinance.productstate=='yhlc' %>
    <div class="box_left_title2">
      <div class="box_left_title2_left">
        <ul>
          <li>
            <span class="qq_bankbig red"><% if @banfinance.returnrate!=0 && @banfinance.returnrate!=nil %><%=  format("%0.1f",@banfinance.returnrate*100)%>% <% else %> 0 <% end %></span>
            <span class="qq_banksmall">预期收益率</span>
          </li>
          <li>
            <span class="qq_bankbig red">在售及预售</span>
            <span class="qq_banksmall">销售状态</span>
          </li>
          <li>
            <span class="qq_bankbig red"><%=  @banfinance.incometype %></span>
            <span class="qq_banksmall">产品收益类型</span>
          </li>
        </ul>
      </div>
    </div>
<% end %>
  <div id="rate">
  <h1>收益率介绍</h1>
  <br><br>
      <div id="container" style="width: 100%; height: 400px; "></div>
  <br><br>
    <!--[if !IE]><!-->
      <% if @reserve.length>0 %>
      <h1>当前募集资金</h1>
      <br><br>
      <div id="container2" style="width: 50%; height: 400px; "></div>
      <br><br>
      <% end %>
    <!--<![endif]-->
      <h1>购买流程</h1>
      <img src="/assets/procedure.png">
      <br><br>
    <h1>产品介绍</h1>
  </div>

  <table class="table table-striped table-bordered">
    <% if @banfinance.isorgan==true %>
        <tr>
          <td class="left">发行机构</td>
          <td class="right"><%= @banfinance.trustee%></td>
        </tr>
        <tr>
          <td class="left">是否保本</td>
          <td class="right"><%= @banfinance.btype%></td>
        </tr>
        <tr>
          <td class="left">投资标的</td>
          <td class="right"><%= @banfinance.invsetsubject%></td>
        </tr>
        <tr>
          <td class="left">收益计算方法</td>
          <td class="right"><%= @banfinance.formula%></td>
        </tr>
        <tr>
          <td class="left">风险提示</td>
          <td class="right"><%= @banfinance.risktip%></td>
        </tr>
        <tr>
          <td class="left">产品关键字</td>
          <td class="right"><%= @banfinance.productkeywords%></td>
        </tr>
    <% else %>
      <% if @banfinance.productstate=='yhlc'%>
        <tr>
          <td class="left">发行银行</td>
          <td class="right"><%= @banfinance.trustee%></td>
          <td class="left">销售状态</td>
          <td class="right">在售及预售</td>
        </tr>
        <tr>
          <td class="left">销售起始日</td>
          <td class="right"><%= @banfinance.sailsstart%></td>
          <td class="left">销售截止日</td>
          <td class="right"><%= @banfinance.collectperiod%></td>
        </tr>
          <tr>
            <td class="left">收益起始日</td>
            <td class="right"><%= @banfinance.sreturndate%></td>
            <td class="left">收益到期日</td>
            <td class="right"><%= @banfinance.creturndate%></td>
          </tr>
          <tr>
            <td class="left">投资期限</td>
            <td class="right"><% if @banfinance.investperiod != nil %><%= @banfinance.investperiod%>天<% end %></td>
            <td class="left">发售地区</td>
            <td class="right"><%= @banfinance.distributionarea%></td>
          </tr>
        <tr>
          <td class="left">投资门槛</td>
          <td class="right"><%= @banfinance.startvalue%></td>
          <td class="left">赎回类型</td>
          <td class="right"><%= @banfinance.investearly%></td>
        </tr>
        <tr>
          <td class="left">银行是否有权提前终止</td>
          <td class="right"><%= @banfinance.bankearly%></td>
          <td class="left">投资标的</td>
          <td class="right"><%= @banfinance.underlying%></td>
        </tr>
        <tr>
          <td class="left">投资范围</td>
          <td class="right" colspan="3"><%= @banfinance.issue%></td>
        </tr>
        <tr>
          <td class="left">购买渠道</td>
          <td class="right" colspan="3"><%= @banfinance.pchannels%></td>
        </tr>
        <tr>
          <td class="left">风险提示</td>
          <td class="right" colspan="3"><%= @banfinance.risktip%></td>
        </tr>
      <% elsif @banfinance.productstate=='qslc'%>
            <tr>
              <td class="left">产品代码</td>
              <td class="right"><%= @banfinance.productcode%></td>
              <td class="left">产品简称</td>
              <td class="right"><%= @banfinance.productkeywords%></td>
            </tr>
            <tr>
              <td class="left">产品全称</td>
              <td class="right"><%= @banfinance.bname%></td>
              <td class="left">信息披露网址</td>
              <td class="right"><%= @banfinance.disclosure%></td>
            </tr>
            <tr>
              <td class="left">发行机构</td>
              <td class="right"><%= @banfinance.trustee%></td>
              <td class="left">销售状态</td>
              <td class="right">在售及预售</td>
            </tr>
            <tr>
              <td class="left">成立日期</td>
              <td class="right"><%= @banfinance.sailsstart%></td>
              <td class="left">到期日期</td>
              <td class="right"><%= @banfinance.collectperiod%></td>
            </tr>
            <tr>
              <td class="left">存续期</td>
              <td class="right"><% if @banfinance.investperiod!=0 %><%= @banfinance.investperiod%>天 <% end %></td>
              <td class="left">推广起始日</td>
              <td class="right"><%= @banfinance.promotiondate%></td>
            </tr>
            <tr>
              <td class="left">最低参与金额(元)</td>
              <td class="right"><% if @banfinance.startvalue!=0 %><%=  format("%0.0f",@banfinance.startvalue) %><% end %></td>
              <td class="left">管理人参与金额(万元)</td>
              <td class="right"><%= @banfinance.partiamount%></td>
            </tr>
            <tr>
              <td class="left">管理人</td>
              <td class="right"><%=  @banfinance.administrator %></td>
              <td class="left">托管人</td>
              <td class="right"><%= @banfinance.trust%></td>
            </tr>
            <tr>
              <td class="left">现任投资经理</td>
              <td class="right"><%=  @banfinance.investmanager %></td>
              <td class="left">历任投资经理</td>
              <td class="right"><%= @banfinance.bfinvestmanager%></td>
            </tr>
            <tr>
              <td class="left">有效认购户数</td>
              <td class="right"><%=  @banfinance.effectsubnumber %></td>
              <td class="left">是否提取业绩报酬</td>
              <td class="right"><%= @banfinance.isexreward%></td>
            </tr>
            <tr>
              <td class="left">目标规模(亿元)</td>
              <td class="right"><%=  @banfinance.targetscale %></td>
              <td class="left">成立规模(亿份)</td>
              <td class="right"><%= @banfinance.establishscale%></td>
            </tr>
      <% else %>
          <tr>
            <td class="left">产品名称</td>
            <td class="right"><%= @banfinance.bname%></td>
          </tr>
          <tr>
            <td class="left">推介起始日</td>
            <td class="right"><%= @banfinance.sailsstart%></td>
          </tr>
          <tr>
            <td class="left">推介截止日</td>
            <td class="right"><%= @banfinance.collectperiod%></td>
          </tr>
          <tr>
            <td class="left">受托人</td>
            <td class="right"><%= @banfinance.trustee%></td>
          </tr>
          <tr>
            <td class="left">实际募集规模(万元)</td>
            <% if @banfinance.salesscale!=nil %>   <td class="right"><%= @banfinance.salesscale*10000%></td>  <% else %>  <td class="right"></td>  <% end %>
          </tr>
          <tr>
            <td class="left">存续期</td>
            <td class="right"><%= @banfinance.investperiod%></td>
          </tr>
          <tr>
            <td class="left">预期收益率</td>
            <% if @banfinance.returnrate!=0 && @banfinance.returnrate!=nil %> <td class="right"><%= @banfinance.returnrate*100%>%</td> <% else %>  <td class="right"></td>  <% end %>
          </tr>
          <tr>
            <td class="left">发行地</td>
            <td class="right"><%= @banfinance.distributionarea%></td>
          </tr>
          <tr>
            <td class="left">运用方式</td>
            <td class="right"><%= @banfinance.bmodel%></td>
          </tr>
          <tr>
            <td class="left">投资顾问</td>
            <td class="right"><%= @banfinance.investadviser%></td>
          </tr>
      <% end %>
    <% end %>
  </table>
<% if @banfinance.isorgan==true %>
    </div>
<% else %>
    </div>
<% end %>
</div>

<script type="text/javascript">

    window.onload=function(){
        if(Request('rate')!=1){
            $("#rate").remove();
        }
    }

    $("#reserve").click(function(){
        <% if session[:webusername]==nil %>
           location.href="/sales/login?bid=<%= @banfinance.id%>";
        <% else %>
           location.href="/sales/index?bid=<%= @banfinance.id%>";
        <% end %>
    });

    $(function () {
        var chart;
        $(document).ready(function() {
            var options ={
                chart: {
                    renderTo: 'container',
                    type: 'column'
                },
                title: {
                    text: false
                },
                xAxis: {
                    categories: [ '<%= format("%0.0f",@banfinance.rate1) %>万', '<%= format("%0.0f",@banfinance.rate2) %>万', '<%= format("%0.0f",@banfinance.rate3) %>万']
                },
                yAxis : {
                    title : {
                        text: '收益率 ( % )'
                    },
                    min: 4,
                    plotLines : [{
                        value : 0,
                        width : 1,
                        color : '#808080'
                    } ]
                },
                tooltip: {
                    formatter: function() {
                        if(this.series.name=='通天顺标准'){
                            return '<b>'+ this.x +'</b><br/>'+
                                    this.series.name +': '+ this.point.stackTotal+'%';
                        }
                        else{
                            return '<b>'+ this.x +'</b><br/>'+
                                    this.series.name +': '+ this.y +'%';
                        }
                    }
                },
                plotOptions: {
                    column: {
                        stacking: 'normal',
                        dataLabels: {
                            enabled: false,
                            color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
                        }
                    }
                },
                series: [],
                credits: {
                    enabled: false
                }
            }
            options.series = new Array();
            var i;
            for(i=0;i<2;i++)
            {
                options.series[i] = new Object();
                if(i==0){
                    options.series[i].name = '通天顺标准';
                    options.series[i].data = new Array(<%= @banfinance.tong10-@banfinance.bank10 %>,<%= @banfinance.tong100-@banfinance.bank100 %>,<%= @banfinance.tong500-@banfinance.bank500 %>);
                }
                else{
                    options.series[i].name = '银行标准';
                    options.series[i].data = new Array(<%= @banfinance.bank10 %>,<%= @banfinance.bank100 %>,<%= @banfinance.bank500 %>);
                }
            }
            chart = new Highcharts.Chart(options);
        });
    });

    $(function () {
        var chart;
        $(document).ready(function() {
            chart = new Highcharts.Chart({
                chart: {
                    renderTo: 'container2',
                    type: 'column'
                },
                title: false,
                xAxis: {
                    categories: ['会员']
                },

                yAxis: {
                    min: 0,
                    title: {
                        text: '总投资金额'
                    },
                    labels: {
                        formatter: function() {
                            return parseInt(this.value/10000)+'万';
                        }
                    },
                    stackLabels: {
                        enabled: true,
                        style: {
                            fontWeight: 'bold',
                            color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
                        }
                    }
                },
               /*
                yAxis: [
                    {
                        lineWidth:1,
                        title: {
                            text:  '总投资金额'
                        },
                        labels: {
                            formatter: function() {
                                return this.value;
                            }
                        }
                    },
                    {
                        lineWidth:1,
                        opposite: true,
                        max:10,
                        min:0,
                        title:{
                            text: '收益率'
                        },
                        labels: {
                            formatter: function() {
                                return this.value ;
                            }
                        }
                    }
                ],
                 */
                tooltip: {
                    formatter: function() {
                        return '<b>'+ this.x +'</b><br/>'+
                                this.series.name +': '+ this.y +'<br/>'+
                                '总共: '+ this.point.stackTotal;
                    }
                },
                plotOptions: {
                    column: {
                        stacking: 'normal',
                        dataLabels: {
                            enabled: true,
                            color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
                        }
                    }
                },
                series: [
                    <% @reserve.each do |b| %>
                    {
                        name: '<%= b.username %>',
                        data: [<%= b.investamount %>]
                    } ,
                    <% end %>
                ],
                credits: {
                    enabled: false
                }
            })
            /*
            options.series = new Array();
            var i=0;
            <% @reserve.each do |b| %>
            options.series[i] = new Object();
            options.series[i].name = '<%= b.username %>';
            options.series[i].data = new Array(<%= b.investamount %>,0);
            i=i+1;
            <% end %>
            chart = new Highcharts.Chart(options);
            */
        });
    });

    function Request(sName)
    {
        var sURL = new String(window.location);
        var sURL = document.location.href;
        sURL=decodeURI(sURL);
        var iQMark= sURL.lastIndexOf('?');
        var iLensName=sName.length;
        //retrieve loc. of sName
        var iStart = sURL.indexOf('?' + sName +'=') //limitation 1
        if (iStart==-1)
        {//not found at start
            iStart = sURL.indexOf('&' + sName +'=')//limitation 1
            if (iStart==-1)
            {//not found at end
                return 0; //not found
            }
        }

        iStart = iStart + + iLensName + 2;
        var iTemp= sURL.indexOf('&',iStart); //next pair start
        if (iTemp ==-1)
        {//EOF
            iTemp=sURL.length;
        }
        return sURL.slice(iStart,iTemp ) ;
        sURL=null;//destroy String
    }
</script>